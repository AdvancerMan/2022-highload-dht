# Отчет по stage 1

В качестве Dao взял свою реализацию на String с прошлого семестра
Сервер имеет 2 ядра, 2 ГБ оперативной памяти и 30 ГБ NVMe, при этом без запуска сервиса и вообще при отсутствии нагрузки
занято оперативы 700 мб, то есть чуть меньше половины


---

### PUT, 10 000 RPS

```
 ./wrk -c 1 -t 1 -d 60s -R 10000 http://62.113.98.110:19235 -s put.lua -L
Running 1m test @ http://62.113.98.110:19235
  1 threads and 1 connections
  Thread calibration: mean lat.: 797.206ms, rate sampling interval: 2924ms
  Thread Stats   Avg      Stdev     99%   +/- Stdev
    Latency   824.13ms  474.06ms   1.63s    57.56%
    Req/Sec     1.26k    85.31     1.33k    88.24%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  824.83ms
 75.000%    1.24s 
 90.000%    1.48s 
 99.000%    1.63s 
 99.900%    1.64s 
 99.990%    1.64s 
 99.999%    1.64s 
100.000%    1.64s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.132     0.000000            1         1.00
     173.439     0.100000         6312         1.11
     335.359     0.200000        12622         1.25
     498.175     0.300000        18936         1.43
     657.919     0.400000        25240         1.67
     824.831     0.500000        31551         2.00
     905.215     0.550000        34717         2.22
     997.887     0.600000        37876         2.50
    1074.175     0.650000        41016         2.86
    1160.191     0.700000        44229         3.33
    1238.015     0.750000        47350         4.00
    1274.879     0.775000        48918         4.44
    1316.863     0.800000        50517         5.00
    1355.775     0.825000        52084         5.71
    1399.807     0.850000        53672         6.67
    1432.575     0.875000        55359         8.00
    1456.127     0.887500        56012         8.89
    1482.751     0.900000        56838        10.00
    1497.087     0.912500        57612        11.43
    1512.447     0.925000        58393        13.33
    1542.143     0.937500        59178        16.00
    1551.359     0.943750        59562        17.78
    1561.599     0.950000        59976        20.00
    1567.743     0.956250        60370        22.86
    1575.935     0.962500        60752        26.67
    1586.175     0.968750        61162        32.00
    1589.247     0.971875        61329        35.56
    1602.559     0.975000        61523        40.00
    1606.655     0.978125        61726        45.71
    1611.775     0.981250        61958        53.33
    1614.847     0.984375        62137        64.00
    1616.895     0.985938        62242        71.11
    1619.967     0.987500        62314        80.00
    1624.063     0.989062        62433        91.43
    1626.111     0.990625        62521       106.67
    1629.183     0.992188        62618       128.00
    1632.255     0.992969        62662       142.22
    1633.279     0.993750        62706       160.00
    1634.303     0.994531        62780       182.86
    1635.327     0.995313        62909       213.33
    1635.327     0.996094        62909       256.00
    1635.327     0.996484        62909       284.44
    1635.327     0.996875        62909       320.00
    1636.351     0.997266        62978       365.71
    1636.351     0.997656        62978       426.67
    1636.351     0.998047        62978       512.00
    1637.375     0.998242        63061       568.89
    1637.375     0.998437        63061       640.00
    1637.375     0.998633        63061       731.43
    1637.375     0.998828        63061       853.33
    1637.375     0.999023        63061      1024.00
    1637.375     0.999121        63061      1137.78
    1637.375     0.999219        63061      1280.00
    1637.375     0.999316        63061      1462.86
    1638.399     0.999414        63086      1706.67
    1638.399     0.999512        63086      2048.00
    1638.399     0.999561        63086      2275.56
    1638.399     0.999609        63086      2560.00
    1638.399     0.999658        63086      2925.71
    1638.399     0.999707        63086      3413.33
    1638.399     0.999756        63086      4096.00
    1639.423     0.999780        63097      4551.11
    1639.423     0.999805        63097      5120.00
    1639.423     0.999829        63097      5851.43
    1639.423     0.999854        63097      6826.67
    1639.423     0.999878        63097      8192.00
    1639.423     0.999890        63097      9102.22
    1639.423     0.999902        63097     10240.00
    1639.423     0.999915        63097     11702.86
    1639.423     0.999927        63097     13653.33
    1639.423     0.999939        63097     16384.00
    1639.423     0.999945        63097     18204.44
    1639.423     0.999951        63097     20480.00
    1642.495     0.999957        63100     23405.71
    1642.495     1.000000        63100          inf
#[Mean    =      824.132, StdDeviation   =      474.063]
#[Max     =     1641.472, Total count    =        63100]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  76120 requests in 1.00m, 9.80MB read
Requests/sec:   1268.41
Transfer/sec:    167.16KB
```

10 000 rps сервис не справляется, 90% запросов обрабатываются меньше, чем за 1.4 с

### PUT, 15 000 rps

```
./wrk -c 1 -t 1 -d 60s -R 15000 http://62.113.98.110:19235 -s put.lua -L
Running 1m test @ http://62.113.98.110:19235
  1 threads and 1 connections
  Thread calibration: mean lat.: 528.229ms, rate sampling interval: 1932ms
  Thread Stats   Avg      Stdev     99%   +/- Stdev
    Latency   534.86ms  312.08ms   1.06s    58.03%
    Req/Sec     1.28k    25.41     1.30k    68.00%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  531.46ms
 75.000%  811.01ms
 90.000%  966.14ms
 99.000%    1.06s 
 99.900%    1.08s 
 99.990%    1.08s 
 99.999%    1.08s 
100.000%    1.08s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.418     0.000000            1         1.00
     100.991     0.100000         6387         1.11
     202.367     0.200000        12768         1.25
     318.207     0.300000        19143         1.43
     429.823     0.400000        25548         1.67
     531.455     0.500000        31902         2.00
     594.431     0.550000        35127         2.22
     649.215     0.600000        38305         2.50
     696.319     0.650000        41471         2.86
     749.055     0.700000        44772         3.33
     811.007     0.750000        47865         4.00
     830.463     0.775000        49449         4.44
     857.599     0.800000        51062         5.00
     887.807     0.825000        52660         5.71
     912.383     0.850000        54257         6.67
     940.543     0.875000        55848         8.00
     958.463     0.887500        56647         8.89
     966.143     0.900000        57423        10.00
     974.847     0.912500        58268        11.43
     990.719     0.925000        59058        13.33
    1004.031     0.937500        59816        16.00
    1016.319     0.943750        60227        17.78
    1024.511     0.950000        60621        20.00
    1032.703     0.956250        61043        22.86
    1036.799     0.962500        61435        26.67
    1039.871     0.968750        61850        32.00
    1042.431     0.971875        62006        35.56
    1044.991     0.975000        62207        40.00
    1048.063     0.978125        62405        45.71
    1051.647     0.981250        62641        53.33
    1054.719     0.984375        62833        64.00
    1057.791     0.985938        62908        71.11
    1060.863     0.987500        63064        80.00
    1061.887     0.989062        63143        91.43
    1063.935     0.990625        63264       106.67
    1064.959     0.992188        63325       128.00
    1065.983     0.992969        63381       142.22
    1067.007     0.993750        63423       160.00
    1069.055     0.994531        63491       182.86
    1070.079     0.995313        63509       213.33
    1073.151     0.996094        63560       256.00
    1074.175     0.996484        63659       284.44
    1074.175     0.996875        63659       320.00
    1074.175     0.997266        63659       365.71
    1074.175     0.997656        63659       426.67
    1076.223     0.998047        63681       512.00
    1077.247     0.998242        63713       568.89
    1077.247     0.998437        63713       640.00
    1077.247     0.998633        63713       731.43
    1078.271     0.998828        63747       853.33
    1078.271     0.999023        63747      1024.00
    1078.271     0.999121        63747      1137.78
    1079.295     0.999219        63787      1280.00
    1079.295     0.999316        63787      1462.86
    1079.295     0.999414        63787      1706.67
    1079.295     0.999512        63787      2048.00
    1079.295     0.999561        63787      2275.56
    1079.295     0.999609        63787      2560.00
    1079.295     0.999658        63787      2925.71
    1079.295     0.999707        63787      3413.33
    1079.295     0.999756        63787      4096.00
    1079.295     0.999780        63787      4551.11
    1080.319     0.999805        63791      5120.00
    1080.319     0.999829        63791      5851.43
    1080.319     0.999854        63791      6826.67
    1082.367     0.999878        63800      8192.00
    1082.367     1.000000        63800          inf
#[Mean    =      534.865, StdDeviation   =      312.078]
#[Max     =     1081.344, Total count    =        63800]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  74609 requests in 1.00m, 9.60MB read
Requests/sec:   1243.44
Transfer/sec:    163.87KB
```

На 15к rps уже время немного лучше, и 90% запросов за 966 мс

### PUT, 100k RPS

```
 ./wrk -c 1 -t 1 -d 60s -R 100000 http://62.113.98.110:19235 -s put.lua -L
Running 1m test @ http://62.113.98.110:19235
  1 threads and 1 connections
  Thread calibration: mean lat.: 191.571ms, rate sampling interval: 680ms
  Thread Stats   Avg      Stdev     99%   +/- Stdev
    Latency   220.57ms  242.09ms   1.20s    86.83%
    Req/Sec   521.12    237.51     0.89k    69.86%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  142.34ms
 75.000%  271.87ms
 90.000%  539.65ms
 99.000%    1.20s 
 99.900%    1.33s 
 99.990%    1.40s 
 99.999%    1.40s 
100.000%    1.40s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.046     0.000000            1         1.00
      22.143     0.100000         2619         1.11
      46.015     0.200000         5250         1.25
      84.799     0.300000         7867         1.43
     113.343     0.400000        10474         1.67
     142.335     0.500000        13095         2.00
     163.455     0.550000        14413         2.22
     181.759     0.600000        15782         2.50
     199.551     0.650000        17037         2.86
     228.863     0.700000        18336         3.33
     271.871     0.750000        19649         4.00
     299.775     0.775000        20296         4.44
     338.687     0.800000        20948         5.00
     370.431     0.825000        21606         5.71
     423.167     0.850000        22264         6.67
     468.735     0.875000        22923         8.00
     495.359     0.887500        23244         8.89
     539.647     0.900000        23569        10.00
     568.831     0.912500        23897        11.43
     590.335     0.925000        24226        13.33
     648.191     0.937500        24574        16.00
     670.207     0.943750        24715        17.78
     725.503     0.950000        24880        20.00
     775.167     0.956250        25041        22.86
     894.975     0.962500        25206        26.67
     962.559     0.968750        25371        32.00
     983.039     0.971875        25449        35.56
     990.719     0.975000        25551        40.00
    1027.071     0.978125        25626        45.71
    1042.943     0.981250        25696        53.33
    1082.367     0.984375        25778        64.00
    1107.967     0.985938        25827        71.11
    1111.039     0.987500        25860        80.00
    1197.055     0.989062        25962        91.43
    1197.055     0.990625        25962       106.67
    1229.823     0.992188        26000       128.00
    1249.279     0.992969        26002       142.22
    1253.375     0.993750        26022       160.00
    1274.879     0.994531        26046       182.86
    1276.927     0.995313        26067       213.33
    1277.951     0.996094        26088       256.00
    1278.975     0.996484        26105       284.44
    1278.975     0.996875        26105       320.00
    1279.999     0.997266        26134       365.71
    1279.999     0.997656        26134       426.67
    1279.999     0.998047        26134       512.00
    1290.239     0.998242        26144       568.89
    1291.263     0.998437        26151       640.00
    1291.263     0.998633        26151       731.43
    1330.175     0.998828        26160       853.33
    1330.175     0.999023        26160      1024.00
    1357.823     0.999121        26171      1137.78
    1357.823     0.999219        26171      1280.00
    1357.823     0.999316        26171      1462.86
    1357.823     0.999414        26171      1706.67
    1373.183     0.999512        26181      2048.00
    1373.183     0.999561        26181      2275.56
    1373.183     0.999609        26181      2560.00
    1373.183     0.999658        26181      2925.71
    1373.183     0.999707        26181      3413.33
    1373.183     0.999756        26181      4096.00
    1373.183     0.999780        26181      4551.11
    1373.183     0.999805        26181      5120.00
    1373.183     0.999829        26181      5851.43
    1396.735     0.999854        26185      6826.67
    1396.735     1.000000        26185          inf
#[Mean    =      220.566, StdDeviation   =      242.090]
#[Max     =     1395.712, Total count    =        26185]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  33785 requests in 1.00m, 4.35MB read
Requests/sec:    562.60
Transfer/sec:     74.14KB
```

Интересно, что на 100к запросах в секунду сервер показывает результаты лучше, чем при меньшем числе rps  
Среднее время ожидания 220 мс, а 90% запросов обрабатываются меньше, чем за 539 мс  
Но это объясняется тем, что в этом эксперименте было всего 33785 запросов, а в предыдущих под 75к

---

Для профилирования get запросов была использована предварительно заполненная база на 1.8 ГБ, порядка 60 000 000 записей

### GET, 1000 RPS

```
./wrk -c 1 -t 1 -d 120s -R 1000 http://62.113.98.110:19235 -s get.lua -L
Running 2m test @ http://62.113.98.110:19235
1 threads and 1 connections
Thread calibration: mean lat.: 5261.474ms, rate sampling interval: 18120ms
Thread Stats   Avg      Stdev     99%   +/- Stdev
Latency     8.16s     4.95s   16.72s    56.67%
Req/Sec     9.50      0.50    10.00    100.00%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    8.21s
75.000%   12.46s
90.000%   14.81s
99.000%   16.72s
99.900%   17.74s
99.990%   17.76s
99.999%   17.76s
100.000%   17.76s

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

      18.655     0.000000            1         1.00
    1436.671     0.100000          112         1.11
    2838.527     0.200000          224         1.25
    4517.887     0.300000          336         1.43
    6426.623     0.400000          447         1.67
    8208.383     0.500000          559         2.00
    9183.231     0.550000          615         2.22
    10149.887     0.600000          671         2.50
    10936.319     0.650000          727         2.86
    11747.327     0.700000          782         3.33
    12460.031     0.750000          838         4.00
    12853.247     0.775000          866         4.44
    13271.039     0.800000          894         5.00
    13778.943     0.825000          923         5.71
    14147.583     0.850000          951         6.67
    14450.687     0.875000          978         8.00
    14647.295     0.887500          993         8.89
    14827.519     0.900000         1006        10.00
    15040.511     0.912500         1020        11.43
    15212.543     0.925000         1034        13.33
    15450.111     0.937500         1049        16.00
    15589.375     0.943750         1055        17.78
    15663.103     0.950000         1062        20.00
    15802.367     0.956250         1069        22.86
    15974.399     0.962500         1076        26.67
    16089.087     0.968750         1083        32.00
    16146.431     0.971875         1086        35.56
    16195.583     0.975000         1090        40.00
    16277.503     0.978125         1094        45.71
    16334.847     0.981250         1097        53.33
    16351.231     0.984375         1100        64.00
    16375.807     0.985938         1102        71.11
    16498.687     0.987500         1104        80.00
    16646.143     0.989062         1105        91.43
    16941.055     0.990625         1107       106.67
    17121.279     0.992188         1109       128.00
    17186.815     0.992969         1110       142.22
    17285.119     0.993750         1111       160.00
    17285.119     0.994531         1111       182.86
    17448.959     0.995313         1112       213.33
    17563.647     0.996094         1113       256.00
    17645.567     0.996484         1114       284.44
    17645.567     0.996875         1114       320.00
    17645.567     0.997266         1114       365.71
    17711.103     0.997656         1115       426.67
    17711.103     0.998047         1115       512.00
    17743.871     0.998242         1116       568.89
    17743.871     0.998437         1116       640.00
    17743.871     0.998633         1116       731.43
    17743.871     0.998828         1116       853.33
    17743.871     0.999023         1116      1024.00
    17760.255     0.999121         1117      1137.78
    17760.255     1.000000         1117          inf
#[Mean    =     8158.277, StdDeviation   =     4945.942]
#[Max     =    17743.872, Total count    =         1117]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
1205 requests in 2.00m, 160.48KB read
Socket errors: connect 0, read 0, write 0, timeout 1
Non-2xx or 3xx responses: 511
Requests/sec:     10.04
Transfer/sec:      1.34KB
```

Сервис не справляется с нагрузкой на get по рандомному ключу, 90 перцентиле - 14с, а среднее время 8с

---

### GET, 10000 RPS

```
./wrk -c 1 -t 1 -d 120s -R 10000 http://62.113.98.110:19235 -s get.lua -L    
Running 2m test @ http://62.113.98.110:19235
1 threads and 1 connections
Thread calibration: mean lat.: 5206.313ms, rate sampling interval: 18268ms
Thread Stats   Avg      Stdev     99%   +/- Stdev
Latency     6.47s     4.37s   17.47s    65.54%
Req/Sec    10.00      0.58    11.00    100.00%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    6.00s
75.000%    9.08s
90.000%   12.74s
99.000%   17.47s
99.900%   18.32s
99.990%   18.43s
99.999%   18.43s
100.000%   18.43s

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

      49.119     0.000000            1         1.00
    1124.351     0.100000          113         1.11
    2234.367     0.200000          226         1.25
    3512.319     0.300000          338         1.43
    4788.223     0.400000          451         1.67
    6000.639     0.500000          563         2.00
    6610.943     0.550000          620         2.22
    7254.015     0.600000          676         2.50
    7880.703     0.650000          732         2.86
    8462.335     0.700000          789         3.33
    9084.927     0.750000          845         4.00
    9396.223     0.775000          873         4.44
    9707.519     0.800000          901         5.00
10272.767     0.825000          929         5.71
11075.583     0.850000          958         6.67
11804.671     0.875000          986         8.00
12337.151     0.887500         1000         8.89
12779.519     0.900000         1014        10.00
13328.383     0.912500         1028        11.43
14049.279     0.925000         1042        13.33
14721.023     0.937500         1058        16.00
15048.703     0.943750         1063        17.78
15351.807     0.950000         1070        20.00
15728.639     0.956250         1077        22.86
16015.359     0.962500         1084        26.67
16367.615     0.968750         1091        32.00
16646.143     0.971875         1095        35.56
16711.679     0.975000         1098        40.00
16875.519     0.978125         1103        45.71
16924.671     0.981250         1105        53.33
17022.975     0.984375         1109        64.00
17170.431     0.985938         1112        71.11
17170.431     0.987500         1112        80.00
17317.887     0.989062         1114        91.43
17498.111     0.990625         1116       106.67
17629.183     0.992188         1118       128.00
17776.639     0.992969         1119       142.22
17776.639     0.993750         1119       160.00
17907.711     0.994531         1120       182.86
18055.167     0.995313         1121       213.33
18087.935     0.996094         1122       256.00
18120.703     0.996484         1123       284.44
18120.703     0.996875         1123       320.00
18120.703     0.997266         1123       365.71
18186.239     0.997656         1124       426.67
18186.239     0.998047         1124       512.00
18317.311     0.998242         1125       568.89
18317.311     0.998437         1125       640.00
18317.311     0.998633         1125       731.43
18317.311     0.998828         1125       853.33
18317.311     0.999023         1125      1024.00
18431.999     0.999121         1126      1137.78
18431.999     1.000000         1126          inf
#[Mean    =     6470.864, StdDeviation   =     4372.213]
#[Max     =    18415.616, Total count    =         1126]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
1218 requests in 2.00m, 162.22KB read
Socket errors: connect 0, read 0, write 0, timeout 35
Non-2xx or 3xx responses: 527
Requests/sec:     10.15
Transfer/sec:      1.35KB 
```

Цифры немного лучше, чем в прошлом случае, но всё равно в отчете wrk видно, что
итоговый rps был 10, как и в предыдущем случае

---

### Heatmap

[PUT cpu](./put_cpu.html)  
[PUT alloc](./put_alloc.html)  
[GET cpu](./get_cpu.html)  
[GET alloc](./get_alloc.html)

### Анализ PUT

Анализируя flame graph put-запросов, можно заметить, что большую часть времени занимают методы one-nio, а именно чтение
данных из сокета, а сама обработка запроса и сохранение данных в базе занимают примерно 21%, так как по сути это вставка
в мапу в
памяти. Также есть фоновые процессы флаша на диск. Еще на хитмапе есть периоды JIT компиляции и сборщика мусора G1
По аллокация видно, что довольно много памяти выделяется при кодировании кодирования и раскодирования строк в UTF-8, так
как сейчас метод обработки get-запроса принимает строковый id, и чтобы улучшить показатели, можно получать байты

![PUT CPU](img.png)

![PUT alloc](img_2.png)

### Анализ GET

В get-запросах по cpu львиную долю времени занимает поиск в файлах, соответственно чтение long и UTF данных, и можно
улучшить, читая данные большими порциями, а уже потом разделяя их на компоненты
Вообще сейчас много времени тратится на перевод из байтов в строку и обратно, поэтому, реализация через массив байт или
ByteBuffer не имела таких проблем

По аллокациям опять-таки дао больше всего тратит память на создание String и byte[] при поиске записи в файлах
![GET cpu](img_3.png)

![GET alloc](img_4.png)