## Этап 2. Асинхронный сервер (deadline 2022-10-05 23:59:59 MSK)

Вынесите **обработку** запросов в отдельный `ExecutorService` с ограниченной очередью, чтобы разгрузить `SelectorThread`ы HTTP сервера.

Проведите нагрузочное тестирование с помощью [wrk2](https://github.com/giltene/wrk2) с **большим количеством соединений** (не меньше 64) `PUT` и `GET` запросами.

Отпрофилируйте приложение (CPU, alloc и lock) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/Artyomcool/async-profiler).

Для проведения нагрузочного тестирования для утилиты wrk были использованы Scripting(смотри [wrk2](https://github.com/giltene/wrk2), [wrk](https://github.com/wg/wrk/tree/master/scripts)) \
put-request.lua
```
cou = 0
request = function()
    cou = cou + 1
    path="/v0/entity?id=" .. cou
    body=cou
    return wrk.format("PUT", path, nil, body)
end
```

get-request.lua
```
cou = 0
request = function()
    path="/v0/entity?id=" .. math.random(1, 100000)
    return wrk.format("GET", path)
end
```

Тестирование проводится на MacBook Pro (16-inch, 2019) Procesor 2,6 GHz 6-Core Intel Core i7

Параметры для ThreadPoolExecutor:

Размер пула потоков зависит от типа задачи и характеристик системы.
Если пул потоков слишком велик, большое количество потоков будет конкурировать за относительно меньший объем процессора и 
ограниченные ресурсы памяти, что не только повлияет на производительность и приводит к чрезмерному потреблению памяти.
Слишком маленький пул потоков приведет к неполному использованию процессора.

![img.png](img.png)
![img_1.png](img_1.png)

Источник: [Java Concurrency In Practice, section 8.2 Sizing Thread Pools.](https://www.amazon.com/dp/0321349601)

CorePoolSize = N_cpu * U_cpu * (1 + W / С). \
Так как у нас много взаимодействия с диском, 
рекомендуется брать U_cpu * (1 + W / С) примерно равное 2. Поэтому
CorePoolSize = Runtime.getRuntime().availableProcessors() * 2

Проводим тестирование PUT запросами:

Rate=10000

Однопоточная реализация:


Многопоточная реализация:

```
wrk2 -t 6 -c 64 -d 60s -R 10000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
6 threads and 64 connections
Thread calibration: mean lat.: 0.995ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.034ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.057ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.000ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.029ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.023ms, rate sampling interval: 10ms
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     0.98ms  639.61us  37.31ms   83.81%
Req/Sec     1.76k   125.38     4.50k    64.45%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    0.94ms
75.000%    1.28ms
90.000%    1.56ms
99.000%    2.20ms
99.900%    7.80ms
99.990%   20.05ms
99.999%   31.82ms
100.000%   37.34ms

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

       0.068     0.000000            1         1.00
       0.370     0.100000        49979         1.11
       0.525     0.200000       100088         1.25
       0.668     0.300000       150109         1.43
       0.805     0.400000       199937         1.67
       0.939     0.500000       249772         2.00
       1.005     0.550000       274751         2.22
       1.072     0.600000       299922         2.50
       1.139     0.650000       324736         2.86
       1.208     0.700000       349759         3.33
       1.278     0.750000       374665         4.00
       1.316     0.775000       387454         4.44
       1.354     0.800000       399636         5.00
       1.397     0.825000       412251         5.71
       1.443     0.850000       424732         6.67
       1.497     0.875000       437237         8.00
       1.526     0.887500       443446         8.89
       1.559     0.900000       449739        10.00
       1.595     0.912500       455864        11.43
       1.637     0.925000       462067        13.33
       1.687     0.937500       468281        16.00
       1.716     0.943750       471433        17.78
       1.749     0.950000       474572        20.00
       1.785     0.956250       477694        22.86
       1.826     0.962500       480799        26.67
       1.874     0.968750       483955        32.00
       1.900     0.971875       485477        35.56
       1.931     0.975000       487036        40.00
       1.965     0.978125       488578        45.71
       2.009     0.981250       490150        53.33
       2.059     0.984375       491707        64.00
       2.089     0.985938       492483        71.11
       2.127     0.987500       493292        80.00
       2.171     0.989062       494060        91.43
       2.231     0.990625       494823       106.67
       2.311     0.992188       495613       128.00
       2.365     0.992969       495988       142.22
       2.437     0.993750       496385       160.00
       2.533     0.994531       496772       182.86
       2.685     0.995313       497157       213.33
       2.969     0.996094       497549       256.00
       3.193     0.996484       497741       284.44
       3.533     0.996875       497937       320.00
       3.989     0.997266       498132       365.71
       4.627     0.997656       498327       426.67
       5.363     0.998047       498522       512.00
       5.799     0.998242       498620       568.89
       6.227     0.998437       498718       640.00
       6.643     0.998633       498815       731.43
       7.207     0.998828       498912       853.33
       7.859     0.999023       499010      1024.00
       8.279     0.999121       499059      1137.78
       8.679     0.999219       499107      1280.00
       9.111     0.999316       499156      1462.86
       9.663     0.999414       499205      1706.67
      10.263     0.999512       499254      2048.00
      10.583     0.999561       499278      2275.56
      10.943     0.999609       499302      2560.00
      11.407     0.999658       499327      2925.71
      12.279     0.999707       499351      3413.33
      13.511     0.999756       499376      4096.00
      14.367     0.999780       499388      4551.11
      15.607     0.999805       499400      5120.00
      16.543     0.999829       499412      5851.43
      17.327     0.999854       499424      6826.67
      18.543     0.999878       499437      8192.00
      19.071     0.999890       499443      9102.22
      20.447     0.999902       499450     10240.00
      21.103     0.999915       499455     11702.86
      21.887     0.999927       499461     13653.33
      23.311     0.999939       499469     16384.00
      23.359     0.999945       499470     18204.44
      23.807     0.999951       499473     20480.00
      24.735     0.999957       499476     23405.71
      26.511     0.999963       499479     27306.67
      27.423     0.999969       499482     32768.00
      28.399     0.999973       499484     36408.89
      29.343     0.999976       499485     40960.00
      29.519     0.999979       499487     46811.43
      29.903     0.999982       499488     54613.33
      30.831     0.999985       499490     65536.00
      31.647     0.999986       499491     72817.78
      31.647     0.999988       499491     81920.00
      31.823     0.999989       499492     93622.86
      33.119     0.999991       499493    109226.67
      33.567     0.999992       499494    131072.00
      33.567     0.999993       499494    145635.56
      33.567     0.999994       499494    163840.00
      34.815     0.999995       499496    187245.71
      34.815     0.999995       499496    218453.33
      34.815     0.999996       499496    262144.00
      34.815     0.999997       499496    291271.11
      34.815     0.999997       499496    327680.00
      34.815     0.999997       499496    374491.43
      34.815     0.999998       499496    436906.67
      37.343     0.999998       499497    524288.00
      37.343     1.000000       499497          inf
#[Mean    =        0.979, StdDeviation   =        0.640]
#[Max     =       37.312, Total count    =       499497]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
599795 requests in 1.00m, 38.32MB read
Requests/sec:   9996.62
Transfer/sec:    654.08KB
```