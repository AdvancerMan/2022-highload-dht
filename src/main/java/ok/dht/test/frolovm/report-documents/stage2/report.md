## Этап 2. Асинхронный сервер (deadline 2022-10-05 23:59:59 MSK)

Вынесите **обработку** запросов в отдельный `ExecutorService` с ограниченной очередью, чтобы разгрузить `SelectorThread`ы HTTP сервера.

Проведите нагрузочное тестирование с помощью [wrk2](https://github.com/giltene/wrk2) с **большим количеством соединений** (не меньше 64) `PUT` и `GET` запросами.

Отпрофилируйте приложение (CPU, alloc и lock) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/Artyomcool/async-profiler).

Для проведения нагрузочного тестирования для утилиты wrk были использованы Scripting(смотри [wrk2](https://github.com/giltene/wrk2), [wrk](https://github.com/wg/wrk/tree/master/scripts)) \
put-request.lua
```
cou = 0
request = function()
    cou = cou + 1
    path="/v0/entity?id=" .. cou
    body=cou
    return wrk.format("PUT", path, nil, body)
end
```

get-request.lua
```
cou = 0
request = function()
    path="/v0/entity?id=" .. math.random(1, 100000)
    return wrk.format("GET", path)
end
```

Тестирование проводится на MacBook Pro (16-inch, 2019) Procesor 2,6 GHz 6-Core Intel Core i7

Параметры для ThreadPoolExecutor:

Размер пула потоков зависит от типа задачи и характеристик системы.
Если пул потоков слишком велик, большое количество потоков будет конкурировать за относительно меньший объем процессора и 
ограниченные ресурсы памяти, что не только повлияет на производительность и приводит к чрезмерному потреблению памяти.
Слишком маленький пул потоков приведет к неполному использованию процессора.

![img.png](img.png)
![img_1.png](img_1.png)

Источник: [Java Concurrency In Practice, section 8.2 Sizing Thread Pools.](https://www.amazon.com/dp/0321349601)

CorePoolSize = N_cpu * U_cpu * (1 + W / С). \
Так как у нас много взаимодействия с диском, 
рекомендуется брать U_cpu * (1 + W / С) примерно равное 2. Поэтому
CorePoolSize = Runtime.getRuntime().availableProcessors() * 2

Проводим тестирование PUT запросами:

Rate=10000

Однопоточная реализация:
```
Running 1m test @ http://localhost:42342
  1 threads and 1 connections
  Thread calibration: mean lat.: 2.100ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   693.98us  391.20us   3.13ms   64.63%
    Req/Sec    10.50k   743.37    13.33k    69.61%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  684.00us
 75.000%    0.99ms
 90.000%    1.16ms
 99.000%    1.87ms
 99.900%    2.19ms
 99.990%    2.41ms
 99.999%    3.00ms
100.000%    3.13ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.038     0.000000            1         1.00
       0.183     0.100000        50384         1.11
       0.311     0.200000       100146         1.25
       0.437     0.300000       150073         1.43
       0.562     0.400000       200343         1.67
       0.684     0.500000       250083         2.00
       0.745     0.550000       275066         2.22
       0.806     0.600000       300200         2.50
       0.866     0.650000       325153         2.86
       0.926     0.700000       350267         3.33
       0.985     0.750000       375335         4.00
       1.014     0.775000       387731         4.44
       1.043     0.800000       400358         5.00
       1.071     0.825000       412702         5.71
       1.099     0.850000       425132         6.67
       1.127     0.875000       437686         8.00
       1.142     0.887500       444084         8.89
       1.156     0.900000       450335        10.00
       1.170     0.912500       456623        11.43
       1.184     0.925000       462479        13.33
       1.203     0.937500       468844        16.00
       1.218     0.943750       471960        17.78
       1.238     0.950000       474981        20.00
       1.266     0.956250       478130        22.86
       1.312     0.962500       481233        26.67
       1.398     0.968750       484316        32.00
       1.456     0.971875       485885        35.56
       1.518     0.975000       487443        40.00
       1.585     0.978125       489002        45.71
       1.656     0.981250       490571        53.33
       1.729     0.984375       492152        64.00
       1.767     0.985938       492908        71.11
       1.807     0.987500       493705        80.00
       1.846     0.989062       494478        91.43
       1.888     0.990625       495261       106.67
       1.932     0.992188       496036       128.00
       1.957     0.992969       496427       142.22
       1.979     0.993750       496814       160.00
       2.005     0.994531       497203       182.86
       2.031     0.995313       497594       213.33
       2.059     0.996094       497994       256.00
       2.075     0.996484       498197       284.44
       2.089     0.996875       498380       320.00
       2.105     0.997266       498579       365.71
       2.121     0.997656       498772       426.67
       2.139     0.998047       498973       512.00
       2.149     0.998242       499073       568.89
       2.159     0.998437       499168       640.00
       2.169     0.998633       499266       731.43
       2.181     0.998828       499360       853.33
       2.191     0.999023       499449      1024.00
       2.199     0.999121       499515      1137.78
       2.205     0.999219       499552      1280.00
       2.211     0.999316       499600      1462.86
       2.219     0.999414       499654      1706.67
       2.229     0.999512       499700      2048.00
       2.235     0.999561       499724      2275.56
       2.241     0.999609       499742      2560.00
       2.247     0.999658       499771      2925.71
       2.253     0.999707       499795      3413.33
       2.263     0.999756       499815      4096.00
       2.277     0.999780       499829      4551.11
       2.287     0.999805       499840      5120.00
       2.307     0.999829       499852      5851.43
       2.333     0.999854       499864      6826.67
       2.361     0.999878       499877      8192.00
       2.381     0.999890       499883      9102.22
       2.425     0.999902       499889     10240.00
       2.503     0.999915       499895     11702.86
       2.559     0.999927       499901     13653.33
       2.611     0.999939       499907     16384.00
       2.657     0.999945       499910     18204.44
       2.671     0.999951       499913     20480.00
       2.715     0.999957       499916     23405.71
       2.761     0.999963       499920     27306.67
       2.813     0.999969       499922     32768.00
       2.851     0.999973       499924     36408.89
       2.853     0.999976       499925     40960.00
       2.891     0.999979       499927     46811.43
       2.903     0.999982       499928     54613.33
       2.935     0.999985       499930     65536.00
       2.969     0.999986       499931     72817.78
       2.969     0.999988       499931     81920.00
       3.001     0.999989       499932     93622.86
       3.033     0.999991       499933    109226.67
       3.069     0.999992       499934    131072.00
       3.069     0.999993       499934    145635.56
       3.069     0.999994       499934    163840.00
       3.101     0.999995       499935    187245.71
       3.101     0.999995       499935    218453.33
       3.123     0.999996       499936    262144.00
       3.123     0.999997       499936    291271.11
       3.123     0.999997       499936    327680.00
       3.123     0.999997       499936    374491.43
       3.123     0.999998       499936    436906.67
       3.135     0.999998       499937    524288.00
       3.135     1.000000       499937          inf
#[Mean    =        0.694, StdDeviation   =        0.391]
#[Max     =        3.134, Total count    =       499937]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599983 requests in 1.00m, 38.34MB read
Requests/sec:   9999.74
Transfer/sec:    654.28KB
```

Многопоточная реализация:

```
wrk2 -t 6 -c 64 -d 60s -R 10000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 0.914ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.912ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.915ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.914ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.026ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.916ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.97ms  480.93us  11.61ms   67.05%
    Req/Sec     1.75k   222.64     3.44k    72.10%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.94ms
 75.000%    1.29ms
 90.000%    1.57ms
 99.000%    2.17ms
 99.900%    2.76ms
 99.990%    7.84ms
 99.999%   10.66ms
100.000%   11.61ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.071     0.000000            1         1.00
       0.367     0.100000        50232         1.11
       0.521     0.200000       100012         1.25
       0.663     0.300000       149887         1.43
       0.800     0.400000       199839         1.67
       0.937     0.500000       249799         2.00
       1.008     0.550000       274933         2.22
       1.078     0.600000       299860         2.50
       1.149     0.650000       324904         2.86
       1.220     0.700000       349672         3.33
       1.292     0.750000       374694         4.00
       1.329     0.775000       387268         4.44
       1.367     0.800000       399648         5.00
       1.409     0.825000       412125         5.71
       1.456     0.850000       424661         6.67
       1.509     0.875000       437208         8.00
       1.539     0.887500       443441         8.89
       1.572     0.900000       449624        10.00
       1.609     0.912500       455881        11.43
       1.651     0.925000       462144        13.33
       1.701     0.937500       468345        16.00
       1.730     0.943750       471434        17.78
       1.761     0.950000       474507        20.00
       1.798     0.956250       477677        22.86
       1.839     0.962500       480776        26.67
       1.887     0.968750       483890        32.00
       1.915     0.971875       485434        35.56
       1.947     0.975000       487031        40.00
       1.982     0.978125       488565        45.71
       2.022     0.981250       490119        53.33
       2.069     0.984375       491754        64.00
       2.095     0.985938       492519        71.11
       2.121     0.987500       493252        80.00
       2.153     0.989062       494058        91.43
       2.187     0.990625       494799       106.67
       2.233     0.992188       495597       128.00
       2.259     0.992969       495995       142.22
       2.285     0.993750       496370       160.00
       2.315     0.994531       496760       182.86
       2.351     0.995313       497149       213.33
       2.391     0.996094       497529       256.00
       2.415     0.996484       497727       284.44
       2.441     0.996875       497928       320.00
       2.477     0.997266       498114       365.71
       2.517     0.997656       498314       426.67
       2.563     0.998047       498507       512.00
       2.589     0.998242       498606       568.89
       2.623     0.998437       498703       640.00
       2.663     0.998633       498800       731.43
       2.707     0.998828       498894       853.33
       2.765     0.999023       498992      1024.00
       2.809     0.999121       499044      1137.78
       2.855     0.999219       499089      1280.00
       2.929     0.999316       499138      1462.86
       3.013     0.999414       499187      1706.67
       3.353     0.999512       499237      2048.00
       3.691     0.999561       499260      2275.56
       3.923     0.999609       499284      2560.00
       4.359     0.999658       499309      2925.71
       4.911     0.999707       499333      3413.33
       5.275     0.999756       499358      4096.00
       5.511     0.999780       499370      4551.11
       5.779     0.999805       499382      5120.00
       6.351     0.999829       499394      5851.43
       6.915     0.999854       499406      6826.67
       7.471     0.999878       499419      8192.00
       7.755     0.999890       499425      9102.22
       7.983     0.999902       499431     10240.00
       8.455     0.999915       499437     11702.86
       9.015     0.999927       499443     13653.33
       9.159     0.999939       499449     16384.00
       9.351     0.999945       499452     18204.44
       9.695     0.999951       499455     20480.00
       9.943     0.999957       499458     23405.71
      10.039     0.999963       499461     27306.67
      10.183     0.999969       499464     32768.00
      10.199     0.999973       499466     36408.89
      10.207     0.999976       499467     40960.00
      10.391     0.999979       499469     46811.43
      10.415     0.999982       499470     54613.33
      10.623     0.999985       499472     65536.00
      10.631     0.999986       499473     72817.78
      10.631     0.999988       499473     81920.00
      10.663     0.999989       499474     93622.86
      10.671     0.999991       499475    109226.67
      10.695     0.999992       499476    131072.00
      10.695     0.999993       499476    145635.56
      10.695     0.999994       499476    163840.00
      10.807     0.999995       499477    187245.71
      10.807     0.999995       499477    218453.33
      11.431     0.999996       499478    262144.00
      11.431     0.999997       499478    291271.11
      11.431     0.999997       499478    327680.00
      11.431     0.999997       499478    374491.43
      11.431     0.999998       499478    436906.67
      11.615     0.999998       499479    524288.00
      11.615     1.000000       499479          inf
#[Mean    =        0.967, StdDeviation   =        0.481]
#[Max     =       11.608, Total count    =       499479]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  598153 requests in 1.00m, 38.22MB read
Requests/sec:   9969.34
Transfer/sec:    652.29KB
```

Rate=10000

Однопоточная реализация:

```
    Running 1m test @ http://localhost:42342
  1 threads and 1 connections
  Thread calibration: mean lat.: 3.676ms, rate sampling interval: 20ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.09s   869.66ms   2.63s    48.68%
    Req/Sec    15.40k     4.81k   25.26k    66.25%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.16s 
 75.000%    1.87s 
 90.000%    2.26s 
 99.000%    2.56s 
 99.900%    2.63s 
 99.990%    2.63s 
 99.999%    2.63s 
100.000%    2.63s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.037     0.000000            1         1.00
       0.494     0.100000        75029         1.11
       0.931     0.200000       150065         1.25
     240.767     0.300000       225000         1.43
     787.455     0.400000       300004         1.67
    1157.119     0.500000       375047         2.00
    1318.911     0.550000       412665         2.22
    1446.911     0.600000       450246         2.50
    1591.295     0.650000       487474         2.86
    1743.871     0.700000       525163         3.33
    1872.895     0.750000       562570         4.00
    1935.359     0.775000       581295         4.44
    1997.823     0.800000       599945         5.00
    2059.263     0.825000       618753         5.71
    2131.967     0.850000       637458         6.67
    2203.647     0.875000       656253         8.00
    2238.463     0.887500       665625         8.89
    2263.039     0.900000       675307        10.00
    2293.759     0.912500       684565        11.43
    2328.575     0.925000       694134        13.33
    2361.343     0.937500       703350        16.00
    2379.775     0.943750       707737        17.78
    2398.207     0.950000       713074        20.00
    2412.543     0.956250       717726        22.86
    2426.879     0.962500       722258        26.67
    2445.311     0.968750       726806        32.00
    2453.503     0.971875       728982        35.56
    2461.695     0.975000       731310        40.00
    2469.887     0.978125       734390        45.71
    2473.983     0.981250       736391        53.33
    2498.559     0.984375       738245        64.00
    2516.991     0.985938       739515        71.11
    2531.327     0.987500       740631        80.00
    2547.711     0.989062       741820        91.43
    2564.095     0.990625       742939       106.67
    2580.479     0.992188       744178       128.00
    2586.623     0.992969       744714       142.22
    2594.815     0.993750       745399       160.00
    2600.959     0.994531       745996       182.86
    2607.103     0.995313       746549       213.33
    2613.247     0.996094       747158       256.00
    2615.295     0.996484       747376       284.44
    2617.343     0.996875       747582       320.00
    2621.439     0.997266       748031       365.71
    2623.487     0.997656       748226       426.67
    2627.583     0.998047       748710       512.00
    2627.583     0.998242       748710       568.89
    2629.631     0.998437       749278       640.00
    2629.631     0.998633       749278       731.43
    2629.631     0.998828       749278       853.33
    2629.631     0.999023       749278      1024.00
    2629.631     0.999121       749278      1137.78
    2631.679     0.999219       749919      1280.00
    2631.679     1.000000       749919          inf
#[Mean    =     1088.147, StdDeviation   =      869.661]
#[Max     =     2629.632, Total count    =       749919]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  899980 requests in 1.00m, 57.51MB read
Requests/sec:  14999.69
Transfer/sec:      0.96MB
```

Многопоточная реализация:

```
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 1.000ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.040ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.987ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.027ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.938ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.979ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.09ms    1.74ms  61.31ms   99.09%
    Req/Sec     2.64k   253.02    13.50k    88.82%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.97ms
 75.000%    1.32ms
 90.000%    1.59ms
 99.000%    2.58ms
 99.900%   34.94ms
 99.990%   54.37ms
 99.999%   59.17ms
100.000%   61.34ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.068     0.000000            1         1.00
       0.406     0.100000        74961         1.11
       0.569     0.200000       150315         1.25
       0.705     0.300000       225030         1.43
       0.840     0.400000       300143         1.67
       0.974     0.500000       374692         2.00
       1.041     0.550000       412490         2.22
       1.107     0.600000       449812         2.50
       1.175     0.650000       487247         2.86
       1.245     0.700000       524483         3.33
       1.318     0.750000       562387         4.00
       1.355     0.775000       580833         4.44
       1.394     0.800000       599559         5.00
       1.435     0.825000       618177         5.71
       1.481     0.850000       637170         6.67
       1.532     0.875000       655673         8.00
       1.561     0.887500       665050         8.89
       1.594     0.900000       674519        10.00
       1.630     0.912500       683770        11.43
       1.672     0.925000       693092        13.33
       1.721     0.937500       702474        16.00
       1.750     0.943750       707116        17.78
       1.784     0.950000       711856        20.00
       1.822     0.956250       716563        22.86
       1.867     0.962500       721198        26.67
       1.923     0.968750       725839        32.00
       1.959     0.971875       728186        35.56
       2.001     0.975000       730556        40.00
       2.049     0.978125       732905        45.71
       2.109     0.981250       735236        53.33
       2.187     0.984375       737552        64.00
       2.241     0.985938       738732        71.11
       2.315     0.987500       739884        80.00
       2.441     0.989062       741061        91.43
       2.729     0.990625       742222       106.67
       3.381     0.992188       743395       128.00
       3.851     0.992969       743978       142.22
       4.491     0.993750       744567       160.00
       5.343     0.994531       745149       182.86
       6.375     0.995313       745733       213.33
       7.815     0.996094       746320       256.00
       8.903     0.996484       746614       284.44
      10.247     0.996875       746906       320.00
      11.791     0.997266       747198       365.71
      13.959     0.997656       747489       426.67
      16.511     0.998047       747782       512.00
      18.863     0.998242       747928       568.89
      22.143     0.998437       748075       640.00
      26.511     0.998633       748221       731.43
      31.119     0.998828       748367       853.33
      35.455     0.999023       748514      1024.00
      36.863     0.999121       748587      1137.78
      38.431     0.999219       748660      1280.00
      39.967     0.999316       748734      1462.86
      41.983     0.999414       748807      1706.67
      44.735     0.999512       748881      2048.00
      45.919     0.999561       748917      2275.56
      47.423     0.999609       748953      2560.00
      48.543     0.999658       748989      2925.71
      49.695     0.999707       749026      3413.33
      50.975     0.999756       749064      4096.00
      51.327     0.999780       749082      4551.11
      51.711     0.999805       749099      5120.00
      52.447     0.999829       749118      5851.43
      52.991     0.999854       749137      6826.67
      53.663     0.999878       749154      8192.00
      54.079     0.999890       749164      9102.22
      54.463     0.999902       749173     10240.00
      54.815     0.999915       749181     11702.86
      55.135     0.999927       749192     13653.33
      55.807     0.999939       749200     16384.00
      55.935     0.999945       749204     18204.44
      56.127     0.999951       749210     20480.00
      56.511     0.999957       749213     23405.71
      56.799     0.999963       749218     27306.67
      57.119     0.999969       749223     32768.00
      57.407     0.999973       749226     36408.89
      57.439     0.999976       749227     40960.00
      57.759     0.999979       749229     46811.43
      57.983     0.999982       749232     54613.33
      58.463     0.999985       749234     65536.00
      58.623     0.999986       749235     72817.78
      58.655     0.999988       749236     81920.00
      59.103     0.999989       749237     93622.86
      59.391     0.999991       749239    109226.67
      59.935     0.999992       749240    131072.00
      59.935     0.999993       749240    145635.56
      60.383     0.999994       749241    163840.00
      60.383     0.999995       749241    187245.71
      60.607     0.999995       749242    218453.33
      61.023     0.999996       749243    262144.00
      61.023     0.999997       749243    291271.11
      61.023     0.999997       749243    327680.00
      61.023     0.999997       749243    374491.43
      61.279     0.999998       749244    436906.67
      61.279     0.999998       749244    524288.00
      61.279     0.999998       749244    582542.22
      61.279     0.999998       749244    655360.00
      61.279     0.999999       749244    748982.86
      61.343     0.999999       749245    873813.33
      61.343     1.000000       749245          inf
#[Mean    =        1.093, StdDeviation   =        1.742]
#[Max     =       61.312, Total count    =       749245]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  899667 requests in 1.00m, 57.49MB read
Requests/sec:  14994.47
Transfer/sec:      0.96MB
```