## Этап 2. Асинхронный сервер (deadline 2022-10-05 23:59:59 MSK)

Вынесите **обработку** запросов в отдельный `ExecutorService` с ограниченной очередью, чтобы разгрузить `SelectorThread`ы HTTP сервера.

Проведите нагрузочное тестирование с помощью [wrk2](https://github.com/giltene/wrk2) с **большим количеством соединений** (не меньше 64) `PUT` и `GET` запросами.

Отпрофилируйте приложение (CPU, alloc и lock) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/Artyomcool/async-profiler).

Для проведения нагрузочного тестирования для утилиты wrk были использованы Scripting(смотри [wrk2](https://github.com/giltene/wrk2), [wrk](https://github.com/wg/wrk/tree/master/scripts)) \
put-request.lua
```
cou = 0
request = function()
    cou = cou + 1
    path="/v0/entity?id=" .. cou
    body=cou
    return wrk.format("PUT", path, nil, body)
end
```

get-request.lua
```
cou = 0
request = function()
    path="/v0/entity?id=" .. math.random(1, 100000)
    return wrk.format("GET", path)
end
```

Тестирование проводится на MacBook Pro (16-inch, 2019) Procesor 2,6 GHz 6-Core Intel Core i7

Параметры для ThreadPoolExecutor:

Размер пула потоков зависит от типа задачи и характеристик системы.
Если пул потоков слишком велик, большое количество потоков будет конкурировать за относительно меньший объем процессора и 
ограниченные ресурсы памяти, что не только повлияет на производительность и приводит к чрезмерному потреблению памяти.
Слишком маленький пул потоков приведет к неполному использованию процессора.

![img.png](img.png)
![img_1.png](img_1.png)

Источник: [Java Concurrency In Practice, section 8.2 Sizing Thread Pools.](https://www.amazon.com/dp/0321349601)

CorePoolSize = N_cpu * U_cpu * (1 + W / С). \
Так как у нас много взаимодействия с диском, 
рекомендуется брать U_cpu * (1 + W / С) примерно равное 2. Поэтому
CorePoolSize = Runtime.getRuntime().availableProcessors() * 2

Проводим тестирование PUT запросами:

Rate=10000

Однопоточная реализация:
```
Running 1m test @ http://localhost:42342
  1 threads and 1 connections
  Thread calibration: mean lat.: 2.100ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   693.98us  391.20us   3.13ms   64.63%
    Req/Sec    10.50k   743.37    13.33k    69.61%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  684.00us
 75.000%    0.99ms
 90.000%    1.16ms
 99.000%    1.87ms
 99.900%    2.19ms
 99.990%    2.41ms
 99.999%    3.00ms
100.000%    3.13ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.038     0.000000            1         1.00
       0.183     0.100000        50384         1.11
       0.311     0.200000       100146         1.25
       0.437     0.300000       150073         1.43
       0.562     0.400000       200343         1.67
       0.684     0.500000       250083         2.00
       0.745     0.550000       275066         2.22
       0.806     0.600000       300200         2.50
       0.866     0.650000       325153         2.86
       0.926     0.700000       350267         3.33
       0.985     0.750000       375335         4.00
       1.014     0.775000       387731         4.44
       1.043     0.800000       400358         5.00
       1.071     0.825000       412702         5.71
       1.099     0.850000       425132         6.67
       1.127     0.875000       437686         8.00
       1.142     0.887500       444084         8.89
       1.156     0.900000       450335        10.00
       1.170     0.912500       456623        11.43
       1.184     0.925000       462479        13.33
       1.203     0.937500       468844        16.00
       1.218     0.943750       471960        17.78
       1.238     0.950000       474981        20.00
       1.266     0.956250       478130        22.86
       1.312     0.962500       481233        26.67
       1.398     0.968750       484316        32.00
       1.456     0.971875       485885        35.56
       1.518     0.975000       487443        40.00
       1.585     0.978125       489002        45.71
       1.656     0.981250       490571        53.33
       1.729     0.984375       492152        64.00
       1.767     0.985938       492908        71.11
       1.807     0.987500       493705        80.00
       1.846     0.989062       494478        91.43
       1.888     0.990625       495261       106.67
       1.932     0.992188       496036       128.00
       1.957     0.992969       496427       142.22
       1.979     0.993750       496814       160.00
       2.005     0.994531       497203       182.86
       2.031     0.995313       497594       213.33
       2.059     0.996094       497994       256.00
       2.075     0.996484       498197       284.44
       2.089     0.996875       498380       320.00
       2.105     0.997266       498579       365.71
       2.121     0.997656       498772       426.67
       2.139     0.998047       498973       512.00
       2.149     0.998242       499073       568.89
       2.159     0.998437       499168       640.00
       2.169     0.998633       499266       731.43
       2.181     0.998828       499360       853.33
       2.191     0.999023       499449      1024.00
       2.199     0.999121       499515      1137.78
       2.205     0.999219       499552      1280.00
       2.211     0.999316       499600      1462.86
       2.219     0.999414       499654      1706.67
       2.229     0.999512       499700      2048.00
       2.235     0.999561       499724      2275.56
       2.241     0.999609       499742      2560.00
       2.247     0.999658       499771      2925.71
       2.253     0.999707       499795      3413.33
       2.263     0.999756       499815      4096.00
       2.277     0.999780       499829      4551.11
       2.287     0.999805       499840      5120.00
       2.307     0.999829       499852      5851.43
       2.333     0.999854       499864      6826.67
       2.361     0.999878       499877      8192.00
       2.381     0.999890       499883      9102.22
       2.425     0.999902       499889     10240.00
       2.503     0.999915       499895     11702.86
       2.559     0.999927       499901     13653.33
       2.611     0.999939       499907     16384.00
       2.657     0.999945       499910     18204.44
       2.671     0.999951       499913     20480.00
       2.715     0.999957       499916     23405.71
       2.761     0.999963       499920     27306.67
       2.813     0.999969       499922     32768.00
       2.851     0.999973       499924     36408.89
       2.853     0.999976       499925     40960.00
       2.891     0.999979       499927     46811.43
       2.903     0.999982       499928     54613.33
       2.935     0.999985       499930     65536.00
       2.969     0.999986       499931     72817.78
       2.969     0.999988       499931     81920.00
       3.001     0.999989       499932     93622.86
       3.033     0.999991       499933    109226.67
       3.069     0.999992       499934    131072.00
       3.069     0.999993       499934    145635.56
       3.069     0.999994       499934    163840.00
       3.101     0.999995       499935    187245.71
       3.101     0.999995       499935    218453.33
       3.123     0.999996       499936    262144.00
       3.123     0.999997       499936    291271.11
       3.123     0.999997       499936    327680.00
       3.123     0.999997       499936    374491.43
       3.123     0.999998       499936    436906.67
       3.135     0.999998       499937    524288.00
       3.135     1.000000       499937          inf
#[Mean    =        0.694, StdDeviation   =        0.391]
#[Max     =        3.134, Total count    =       499937]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599983 requests in 1.00m, 38.34MB read
Requests/sec:   9999.74
Transfer/sec:    654.28KB
```

Многопоточная реализация:

```
wrk2 -t 6 -c 64 -d 60s -R 10000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 0.914ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.912ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.915ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.914ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.026ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.916ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.97ms  480.93us  11.61ms   67.05%
    Req/Sec     1.75k   222.64     3.44k    72.10%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.94ms
 75.000%    1.29ms
 90.000%    1.57ms
 99.000%    2.17ms
 99.900%    2.76ms
 99.990%    7.84ms
 99.999%   10.66ms
100.000%   11.61ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.071     0.000000            1         1.00
       0.367     0.100000        50232         1.11
       0.521     0.200000       100012         1.25
       0.663     0.300000       149887         1.43
       0.800     0.400000       199839         1.67
       0.937     0.500000       249799         2.00
       1.008     0.550000       274933         2.22
       1.078     0.600000       299860         2.50
       1.149     0.650000       324904         2.86
       1.220     0.700000       349672         3.33
       1.292     0.750000       374694         4.00
       1.329     0.775000       387268         4.44
       1.367     0.800000       399648         5.00
       1.409     0.825000       412125         5.71
       1.456     0.850000       424661         6.67
       1.509     0.875000       437208         8.00
       1.539     0.887500       443441         8.89
       1.572     0.900000       449624        10.00
       1.609     0.912500       455881        11.43
       1.651     0.925000       462144        13.33
       1.701     0.937500       468345        16.00
       1.730     0.943750       471434        17.78
       1.761     0.950000       474507        20.00
       1.798     0.956250       477677        22.86
       1.839     0.962500       480776        26.67
       1.887     0.968750       483890        32.00
       1.915     0.971875       485434        35.56
       1.947     0.975000       487031        40.00
       1.982     0.978125       488565        45.71
       2.022     0.981250       490119        53.33
       2.069     0.984375       491754        64.00
       2.095     0.985938       492519        71.11
       2.121     0.987500       493252        80.00
       2.153     0.989062       494058        91.43
       2.187     0.990625       494799       106.67
       2.233     0.992188       495597       128.00
       2.259     0.992969       495995       142.22
       2.285     0.993750       496370       160.00
       2.315     0.994531       496760       182.86
       2.351     0.995313       497149       213.33
       2.391     0.996094       497529       256.00
       2.415     0.996484       497727       284.44
       2.441     0.996875       497928       320.00
       2.477     0.997266       498114       365.71
       2.517     0.997656       498314       426.67
       2.563     0.998047       498507       512.00
       2.589     0.998242       498606       568.89
       2.623     0.998437       498703       640.00
       2.663     0.998633       498800       731.43
       2.707     0.998828       498894       853.33
       2.765     0.999023       498992      1024.00
       2.809     0.999121       499044      1137.78
       2.855     0.999219       499089      1280.00
       2.929     0.999316       499138      1462.86
       3.013     0.999414       499187      1706.67
       3.353     0.999512       499237      2048.00
       3.691     0.999561       499260      2275.56
       3.923     0.999609       499284      2560.00
       4.359     0.999658       499309      2925.71
       4.911     0.999707       499333      3413.33
       5.275     0.999756       499358      4096.00
       5.511     0.999780       499370      4551.11
       5.779     0.999805       499382      5120.00
       6.351     0.999829       499394      5851.43
       6.915     0.999854       499406      6826.67
       7.471     0.999878       499419      8192.00
       7.755     0.999890       499425      9102.22
       7.983     0.999902       499431     10240.00
       8.455     0.999915       499437     11702.86
       9.015     0.999927       499443     13653.33
       9.159     0.999939       499449     16384.00
       9.351     0.999945       499452     18204.44
       9.695     0.999951       499455     20480.00
       9.943     0.999957       499458     23405.71
      10.039     0.999963       499461     27306.67
      10.183     0.999969       499464     32768.00
      10.199     0.999973       499466     36408.89
      10.207     0.999976       499467     40960.00
      10.391     0.999979       499469     46811.43
      10.415     0.999982       499470     54613.33
      10.623     0.999985       499472     65536.00
      10.631     0.999986       499473     72817.78
      10.631     0.999988       499473     81920.00
      10.663     0.999989       499474     93622.86
      10.671     0.999991       499475    109226.67
      10.695     0.999992       499476    131072.00
      10.695     0.999993       499476    145635.56
      10.695     0.999994       499476    163840.00
      10.807     0.999995       499477    187245.71
      10.807     0.999995       499477    218453.33
      11.431     0.999996       499478    262144.00
      11.431     0.999997       499478    291271.11
      11.431     0.999997       499478    327680.00
      11.431     0.999997       499478    374491.43
      11.431     0.999998       499478    436906.67
      11.615     0.999998       499479    524288.00
      11.615     1.000000       499479          inf
#[Mean    =        0.967, StdDeviation   =        0.481]
#[Max     =       11.608, Total count    =       499479]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  598153 requests in 1.00m, 38.22MB read
Requests/sec:   9969.34
Transfer/sec:    652.29KB
```



