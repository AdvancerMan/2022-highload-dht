## Этап 2. Асинхронный сервер (deadline 2022-10-05 23:59:59 MSK)

Вынесите **обработку** запросов в отдельный `ExecutorService` с ограниченной очередью, чтобы разгрузить `SelectorThread`ы HTTP сервера.

Проведите нагрузочное тестирование с помощью [wrk2](https://github.com/giltene/wrk2) с **большим количеством соединений** (не меньше 64) `PUT` и `GET` запросами.

Отпрофилируйте приложение (CPU, alloc и lock) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/Artyomcool/async-profiler).

Для проведения нагрузочного тестирования для утилиты wrk были использованы Scripting(смотри [wrk2](https://github.com/giltene/wrk2), [wrk](https://github.com/wg/wrk/tree/master/scripts)) \
put-request.lua
```
cou = 0
request = function()
    cou = cou + 1
    path="/v0/entity?id=" .. cou
    body=cou
    return wrk.format("PUT", path, nil, body)
end
```

get-request.lua
```
cou = 0
request = function()
    path="/v0/entity?id=" .. math.random(1, 100000)
    return wrk.format("GET", path)
end
```

Тестирование проводится на MacBook Pro (16-inch, 2019) Procesor 2,6 GHz 6-Core Intel Core i7

Параметры для ThreadPoolExecutor:

Размер пула потоков зависит от типа задачи и характеристик системы.
Если пул потоков слишком велик, большое количество потоков будет конкурировать за относительно меньший объем процессора и 
ограниченные ресурсы памяти, что не только повлияет на производительность и приводит к чрезмерному потреблению памяти.
Слишком маленький пул потоков приведет к неполному использованию процессора.

![img.png](img.png)
![img_1.png](img_1.png)

Источник: [Java Concurrency In Practice, section 8.2 Sizing Thread Pools.](https://www.amazon.com/dp/0321349601)

CorePoolSize = N_cpu * U_cpu * (1 + W / С). \
Так как у нас много взаимодействия с диском, 
рекомендуется брать U_cpu * (1 + W / С) примерно равное 2. Поэтому
CorePoolSize = Runtime.getRuntime().availableProcessors() * 2

Проводим тестирование PUT запросами:

Rate=10000

Однопоточная реализация:
```
    wrk2 -t 1 -c 1 -d 60s -R 10000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.266ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   771.93us    1.53ms  52.00ms   99.73%
    Req/Sec    10.53k   805.09    21.33k    82.05%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  700.00us
 75.000%    1.00ms
 90.000%    1.17ms
 99.000%    1.98ms
 99.900%   30.59ms
 99.990%   51.29ms
 99.999%   51.97ms
100.000%   52.03ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.034     0.000000            2         1.00
       0.193     0.100000        50267         1.11
       0.328     0.200000       100050         1.25
       0.455     0.300000       150171         1.43
       0.578     0.400000       200114         1.67
       0.700     0.500000       250307         2.00
       0.760     0.550000       275319         2.22
       0.819     0.600000       299991         2.50
       0.879     0.650000       325263         2.86
       0.937     0.700000       349973         3.33
       0.996     0.750000       375235         4.00
       1.025     0.775000       387808         4.44
       1.053     0.800000       400127         5.00
       1.082     0.825000       412877         5.71
       1.109     0.850000       425039         6.67
       1.138     0.875000       437826         8.00
       1.151     0.887500       443717         8.89
       1.166     0.900000       450367        10.00
       1.180     0.912500       456555        11.43
       1.196     0.925000       462698        13.33
       1.225     0.937500       468794        16.00
       1.258     0.943750       471860        17.78
       1.303     0.950000       474973        20.00
       1.371     0.956250       478090        22.86
       1.462     0.962500       481236        26.67
       1.562     0.968750       484356        32.00
       1.614     0.971875       485898        35.56
       1.670     0.975000       487480        40.00
       1.728     0.978125       489046        45.71
       1.788     0.981250       490602        53.33
       1.851     0.984375       492169        64.00
       1.884     0.985938       492943        71.11
       1.919     0.987500       493727        80.00
       1.956     0.989062       494494        91.43
       1.997     0.990625       495274       106.67
       2.042     0.992188       496060       128.00
       2.067     0.992969       496456       142.22
       2.091     0.993750       496841       160.00
       2.121     0.994531       497248       182.86
       2.149     0.995313       497637       213.33
       2.183     0.996094       498012       256.00
       2.203     0.996484       498214       284.44
       2.227     0.996875       498397       320.00
       2.271     0.997266       498592       365.71
       3.371     0.997656       498788       426.67
       9.607     0.998047       498983       512.00
      14.311     0.998242       499081       568.89
      18.639     0.998437       499178       640.00
      23.295     0.998633       499276       731.43
      27.103     0.998828       499374       853.33
      31.199     0.999023       499471      1024.00
      33.631     0.999121       499520      1137.78
      35.871     0.999219       499569      1280.00
      38.239     0.999316       499618      1462.86
      40.255     0.999414       499667      1706.67
      42.399     0.999512       499715      2048.00
      43.615     0.999561       499740      2275.56
      44.767     0.999609       499764      2560.00
      45.951     0.999658       499789      2925.71
      47.007     0.999707       499813      3413.33
      48.031     0.999756       499837      4096.00
      48.607     0.999780       499850      4551.11
      49.087     0.999805       499862      5120.00
      49.599     0.999829       499874      5851.43
      50.239     0.999854       499886      6826.67
      50.751     0.999878       499898      8192.00
      51.103     0.999890       499905      9102.22
      51.359     0.999902       499911     10240.00
      51.615     0.999915       499917     11702.86
      51.807     0.999927       499929     13653.33
      51.807     0.999939       499929     16384.00
      51.839     0.999945       499933     18204.44
      51.871     0.999951       499938     20480.00
      51.871     0.999957       499938     23405.71
      51.903     0.999963       499944     27306.67
      51.903     0.999969       499944     32768.00
      51.935     0.999973       499951     36408.89
      51.935     0.999976       499951     40960.00
      51.935     0.999979       499951     46811.43
      51.935     0.999982       499951     54613.33
      51.967     0.999985       499955     65536.00
      51.967     0.999986       499955     72817.78
      51.967     0.999988       499955     81920.00
      51.967     0.999989       499955     93622.86
      51.967     0.999991       499955    109226.67
      51.999     0.999992       499957    131072.00
      51.999     0.999993       499957    145635.56
      51.999     0.999994       499957    163840.00
      51.999     0.999995       499957    187245.71
      51.999     0.999995       499957    218453.33
      52.031     0.999996       499959    262144.00
      52.031     1.000000       499959          inf
#[Mean    =        0.772, StdDeviation   =        1.527]
#[Max     =       52.000, Total count    =       499959]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599984 requests in 1.00m, 38.34MB read
Requests/sec:   9999.76
Transfer/sec:    654.28KB
```

Многопоточная реализация:

```
wrk2 -t 6 -c 64 -d 60s -R 10000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
6 threads and 64 connections
Thread calibration: mean lat.: 0.995ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.034ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.057ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.000ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.029ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.023ms, rate sampling interval: 10ms
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     0.98ms  639.61us  37.31ms   83.81%
Req/Sec     1.76k   125.38     4.50k    64.45%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    0.94ms
75.000%    1.28ms
90.000%    1.56ms
99.000%    2.20ms
99.900%    7.80ms
99.990%   20.05ms
99.999%   31.82ms
100.000%   37.34ms

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

       0.068     0.000000            1         1.00
       0.370     0.100000        49979         1.11
       0.525     0.200000       100088         1.25
       0.668     0.300000       150109         1.43
       0.805     0.400000       199937         1.67
       0.939     0.500000       249772         2.00
       1.005     0.550000       274751         2.22
       1.072     0.600000       299922         2.50
       1.139     0.650000       324736         2.86
       1.208     0.700000       349759         3.33
       1.278     0.750000       374665         4.00
       1.316     0.775000       387454         4.44
       1.354     0.800000       399636         5.00
       1.397     0.825000       412251         5.71
       1.443     0.850000       424732         6.67
       1.497     0.875000       437237         8.00
       1.526     0.887500       443446         8.89
       1.559     0.900000       449739        10.00
       1.595     0.912500       455864        11.43
       1.637     0.925000       462067        13.33
       1.687     0.937500       468281        16.00
       1.716     0.943750       471433        17.78
       1.749     0.950000       474572        20.00
       1.785     0.956250       477694        22.86
       1.826     0.962500       480799        26.67
       1.874     0.968750       483955        32.00
       1.900     0.971875       485477        35.56
       1.931     0.975000       487036        40.00
       1.965     0.978125       488578        45.71
       2.009     0.981250       490150        53.33
       2.059     0.984375       491707        64.00
       2.089     0.985938       492483        71.11
       2.127     0.987500       493292        80.00
       2.171     0.989062       494060        91.43
       2.231     0.990625       494823       106.67
       2.311     0.992188       495613       128.00
       2.365     0.992969       495988       142.22
       2.437     0.993750       496385       160.00
       2.533     0.994531       496772       182.86
       2.685     0.995313       497157       213.33
       2.969     0.996094       497549       256.00
       3.193     0.996484       497741       284.44
       3.533     0.996875       497937       320.00
       3.989     0.997266       498132       365.71
       4.627     0.997656       498327       426.67
       5.363     0.998047       498522       512.00
       5.799     0.998242       498620       568.89
       6.227     0.998437       498718       640.00
       6.643     0.998633       498815       731.43
       7.207     0.998828       498912       853.33
       7.859     0.999023       499010      1024.00
       8.279     0.999121       499059      1137.78
       8.679     0.999219       499107      1280.00
       9.111     0.999316       499156      1462.86
       9.663     0.999414       499205      1706.67
      10.263     0.999512       499254      2048.00
      10.583     0.999561       499278      2275.56
      10.943     0.999609       499302      2560.00
      11.407     0.999658       499327      2925.71
      12.279     0.999707       499351      3413.33
      13.511     0.999756       499376      4096.00
      14.367     0.999780       499388      4551.11
      15.607     0.999805       499400      5120.00
      16.543     0.999829       499412      5851.43
      17.327     0.999854       499424      6826.67
      18.543     0.999878       499437      8192.00
      19.071     0.999890       499443      9102.22
      20.447     0.999902       499450     10240.00
      21.103     0.999915       499455     11702.86
      21.887     0.999927       499461     13653.33
      23.311     0.999939       499469     16384.00
      23.359     0.999945       499470     18204.44
      23.807     0.999951       499473     20480.00
      24.735     0.999957       499476     23405.71
      26.511     0.999963       499479     27306.67
      27.423     0.999969       499482     32768.00
      28.399     0.999973       499484     36408.89
      29.343     0.999976       499485     40960.00
      29.519     0.999979       499487     46811.43
      29.903     0.999982       499488     54613.33
      30.831     0.999985       499490     65536.00
      31.647     0.999986       499491     72817.78
      31.647     0.999988       499491     81920.00
      31.823     0.999989       499492     93622.86
      33.119     0.999991       499493    109226.67
      33.567     0.999992       499494    131072.00
      33.567     0.999993       499494    145635.56
      33.567     0.999994       499494    163840.00
      34.815     0.999995       499496    187245.71
      34.815     0.999995       499496    218453.33
      34.815     0.999996       499496    262144.00
      34.815     0.999997       499496    291271.11
      34.815     0.999997       499496    327680.00
      34.815     0.999997       499496    374491.43
      34.815     0.999998       499496    436906.67
      37.343     0.999998       499497    524288.00
      37.343     1.000000       499497          inf
#[Mean    =        0.979, StdDeviation   =        0.640]
#[Max     =       37.312, Total count    =       499497]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
599795 requests in 1.00m, 38.32MB read
Requests/sec:   9996.62
Transfer/sec:    654.08KB
```