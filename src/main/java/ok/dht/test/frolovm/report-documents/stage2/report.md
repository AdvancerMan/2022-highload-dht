## Этап 2. Асинхронный сервер (deadline 2022-10-05 23:59:59 MSK)

Вынесите **обработку** запросов в отдельный `ExecutorService` с ограниченной очередью, чтобы разгрузить `SelectorThread`ы HTTP сервера.

Проведите нагрузочное тестирование с помощью [wrk2](https://github.com/giltene/wrk2) с **большим количеством соединений** (не меньше 64) `PUT` и `GET` запросами.

Отпрофилируйте приложение (CPU, alloc и lock) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/Artyomcool/async-profiler).

Для проведения нагрузочного тестирования для утилиты wrk были использованы Scripting(смотри [wrk2](https://github.com/giltene/wrk2), [wrk](https://github.com/wg/wrk/tree/master/scripts)) \
put-request.lua
```
cou = 0
request = function()
    cou = cou + 1
    path="/v0/entity?id=" .. cou
    body=cou
    return wrk.format("PUT", path, nil, body)
end
```

get-request.lua
```
cou = 0
request = function()
    path="/v0/entity?id=" .. math.random(1, 100000)
    return wrk.format("GET", path)
end
```

### Синхронная реализация 

### PUT

```
wrk2 -t 6 -c 64 -d 60s -R 50000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
    Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 1.577ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.585ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.569ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.560ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.639ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.661ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.64ms    4.42ms  94.46ms   99.01%
    Req/Sec     8.79k   766.17    19.22k    81.30%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.22ms
 75.000%    1.66ms
 90.000%    2.11ms
 99.000%    5.53ms
 99.900%   75.14ms
 99.990%   90.11ms
 99.999%   92.61ms
100.000%   94.53ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.041     0.000000            1         1.00
       0.534     0.100000       250357         1.11
       0.728     0.200000       499609         1.25
       0.896     0.300000       750549         1.43
       1.056     0.400000       999180         1.67
       1.217     0.500000      1248850         2.00
       1.300     0.550000      1374832         2.22
       1.384     0.600000      1498637         2.50
       1.472     0.650000      1624180         2.86
       1.564     0.700000      1748587         3.33
       1.665     0.750000      1873800         4.00
       1.720     0.775000      1936090         4.44
       1.780     0.800000      1998680         5.00
       1.845     0.825000      2060547         5.71
       1.918     0.850000      2123306         6.67
       2.003     0.875000      2185730         8.00
       2.051     0.887500      2216745         8.89
       2.105     0.900000      2248753        10.00
       2.163     0.912500      2279121        11.43
       2.233     0.925000      2310818        13.33
       2.311     0.937500      2341402        16.00
       2.357     0.943750      2357057        17.78
       2.409     0.950000      2372805        20.00
       2.467     0.956250      2388579        22.86
       2.535     0.962500      2404190        26.67
       2.615     0.968750      2419708        32.00
       2.663     0.971875      2427506        35.56
       2.717     0.975000      2435255        40.00
       2.781     0.978125      2443036        45.71
       2.859     0.981250      2450712        53.33
       2.969     0.984375      2458458        64.00
       3.049     0.985938      2462417        71.11
       3.173     0.987500      2466287        80.00
       3.681     0.989062      2470166        91.43
       9.703     0.990625      2474066       106.67
      20.383     0.992188      2477972       128.00
      23.615     0.992969      2479921       142.22
      26.511     0.993750      2481875       160.00
      30.511     0.994531      2483823       182.86
      34.655     0.995313      2485783       213.33
      39.071     0.996094      2487728       256.00
      42.111     0.996484      2488700       284.44
      48.191     0.996875      2489679       320.00
      54.783     0.997266      2490652       365.71
      58.687     0.997656      2491626       426.67
      62.015     0.998047      2492604       512.00
      63.807     0.998242      2493090       568.89
      66.431     0.998437      2493583       640.00
      69.375     0.998633      2494072       731.43
      72.511     0.998828      2494556       853.33
      75.519     0.999023      2495047      1024.00
      76.991     0.999121      2495289      1137.78
      78.527     0.999219      2495528      1280.00
      80.063     0.999316      2495775      1462.86
      81.535     0.999414      2496021      1706.67
      83.071     0.999512      2496267      2048.00
      83.775     0.999561      2496387      2275.56
      84.415     0.999609      2496508      2560.00
      85.311     0.999658      2496635      2925.71
      86.271     0.999707      2496751      3413.33
      87.231     0.999756      2496870      4096.00
      87.743     0.999780      2496937      4551.11
      88.191     0.999805      2496994      5120.00
      88.703     0.999829      2497062      5851.43
      89.151     0.999854      2497119      6826.67
      89.663     0.999878      2497182      8192.00
      89.855     0.999890      2497207      9102.22
      90.175     0.999902      2497242     10240.00
      90.367     0.999915      2497270     11702.86
      90.623     0.999927      2497301     13653.33
      90.943     0.999939      2497332     16384.00
      91.199     0.999945      2497351     18204.44
      91.327     0.999951      2497364     20480.00
      91.391     0.999957      2497374     23405.71
      91.647     0.999963      2497396     27306.67
      91.775     0.999969      2497408     32768.00
      91.839     0.999973      2497418     36408.89
      91.903     0.999976      2497420     40960.00
      91.967     0.999979      2497426     46811.43
      92.159     0.999982      2497435     54613.33
      92.287     0.999985      2497443     65536.00
      92.351     0.999986      2497447     72817.78
      92.415     0.999988      2497449     81920.00
      92.543     0.999989      2497453     93622.86
      92.607     0.999991      2497457    109226.67
      92.735     0.999992      2497461    131072.00
      92.863     0.999993      2497462    145635.56
      92.991     0.999994      2497464    163840.00
      93.055     0.999995      2497466    187245.71
      93.119     0.999995      2497468    218453.33
      93.183     0.999996      2497471    262144.00
      93.183     0.999997      2497471    291271.11
      93.311     0.999997      2497473    327680.00
      93.311     0.999997      2497473    374491.43
      93.439     0.999998      2497475    436906.67
      93.439     0.999998      2497475    524288.00
      93.439     0.999998      2497475    582542.22
      93.503     0.999998      2497476    655360.00
      93.503     0.999999      2497476    748982.86
      93.759     0.999999      2497477    873813.33
      93.759     0.999999      2497477   1048576.00
      93.759     0.999999      2497477   1165084.44
      94.207     0.999999      2497478   1310720.00
      94.207     0.999999      2497478   1497965.71
      94.207     0.999999      2497478   1747626.67
      94.207     1.000000      2497478   2097152.00
      94.207     1.000000      2497478   2330168.89
      94.527     1.000000      2497479   2621440.00
      94.527     1.000000      2497479          inf
#[Mean    =        1.642, StdDeviation   =        4.423]
#[Max     =       94.464, Total count    =      2497479]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2990648 requests in 1.00m, 191.09MB read
Requests/sec:  49843.68
Transfer/sec:      3.18MB
```

### GET 
```
wrk2 -t 6 -c 64 -d 60s -R 50000 -s requests-wrk/get-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
  6 threads and 64 connections
  Thread calibration: mean lat.: 1.286ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.287ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.272ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.280ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.286ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.283ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.27ms  591.70us   3.79ms   66.33%
    Req/Sec     8.78k   576.03    11.22k    69.67%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.22ms
 75.000%    1.66ms
 90.000%    2.08ms
 99.000%    2.80ms
 99.900%    3.17ms
 99.990%    3.41ms
 99.999%    3.60ms
100.000%    3.79ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.038     0.000000            1         1.00
       0.536     0.100000       250597         1.11
       0.728     0.200000       500470         1.25
       0.895     0.300000       750520         1.43
       1.056     0.400000       999262         1.67
       1.220     0.500000      1250218         2.00
       1.302     0.550000      1373833         2.22
       1.387     0.600000      1498875         2.50
       1.475     0.650000      1624705         2.86
       1.566     0.700000      1749382         3.33
       1.664     0.750000      1874104         4.00
       1.717     0.775000      1936298         4.44
       1.774     0.800000      1998928         5.00
       1.836     0.825000      2061324         5.71
       1.904     0.850000      2123300         6.67
       1.982     0.875000      2185569         8.00
       2.026     0.887500      2216905         8.89
       2.075     0.900000      2248264        10.00
       2.129     0.912500      2279834        11.43
       2.189     0.925000      2310572        13.33
       2.259     0.937500      2342108        16.00
       2.297     0.943750      2357463        17.78
       2.339     0.950000      2372892        20.00
       2.385     0.956250      2388223        22.86
       2.437     0.962500      2403958        26.67
       2.497     0.968750      2419815        32.00
       2.529     0.971875      2427621        35.56
       2.563     0.975000      2435109        40.00
       2.603     0.978125      2443261        45.71
       2.645     0.981250      2450951        53.33
       2.691     0.984375      2458466        64.00
       2.719     0.985938      2462547        71.11
       2.747     0.987500      2466342        80.00
       2.779     0.989062      2470353        91.43
       2.813     0.990625      2474234       106.67
       2.851     0.992188      2478009       128.00
       2.873     0.992969      2480028       142.22
       2.895     0.993750      2481954       160.00
       2.919     0.994531      2483813       182.86
       2.947     0.995313      2485795       213.33
       2.979     0.996094      2487734       256.00
       2.997     0.996484      2488793       284.44
       3.015     0.996875      2489692       320.00
       3.037     0.997266      2490706       365.71
       3.061     0.997656      2491681       426.67
       3.087     0.998047      2492612       512.00
       3.101     0.998242      2493092       568.89
       3.117     0.998437      2493598       640.00
       3.135     0.998633      2494053       731.43
       3.155     0.998828      2494570       853.33
       3.179     0.999023      2495048      1024.00
       3.191     0.999121      2495300      1137.78
       3.205     0.999219      2495535      1280.00
       3.219     0.999316      2495778      1462.86
       3.235     0.999414      2496013      1706.67
       3.255     0.999512      2496247      2048.00
       3.267     0.999561      2496388      2275.56
       3.277     0.999609      2496491      2560.00
       3.293     0.999658      2496613      2925.71
       3.309     0.999707      2496747      3413.33
       3.329     0.999756      2496866      4096.00
       3.339     0.999780      2496925      4551.11
       3.349     0.999805      2496980      5120.00
       3.363     0.999829      2497038      5851.43
       3.377     0.999854      2497106      6826.67
       3.397     0.999878      2497168      8192.00
       3.403     0.999890      2497196      9102.22
       3.415     0.999902      2497230     10240.00
       3.423     0.999915      2497252     11702.86
       3.437     0.999927      2497286     13653.33
       3.449     0.999939      2497312     16384.00
       3.459     0.999945      2497327     18204.44
       3.471     0.999951      2497345     20480.00
       3.479     0.999957      2497361     23405.71
       3.491     0.999963      2497376     27306.67
       3.503     0.999969      2497388     32768.00
       3.513     0.999973      2497399     36408.89
       3.521     0.999976      2497405     40960.00
       3.529     0.999979      2497412     46811.43
       3.541     0.999982      2497419     54613.33
       3.565     0.999985      2497426     65536.00
       3.575     0.999986      2497430     72817.78
       3.583     0.999988      2497434     81920.00
       3.595     0.999989      2497438     93622.86
       3.607     0.999991      2497442    109226.67
       3.615     0.999992      2497445    131072.00
       3.631     0.999993      2497447    145635.56
       3.637     0.999994      2497449    163840.00
       3.647     0.999995      2497452    187245.71
       3.655     0.999995      2497453    218453.33
       3.663     0.999996      2497456    262144.00
       3.663     0.999997      2497456    291271.11
       3.669     0.999997      2497457    327680.00
       3.671     0.999997      2497458    374491.43
       3.701     0.999998      2497459    436906.67
       3.703     0.999998      2497460    524288.00
       3.703     0.999998      2497460    582542.22
       3.707     0.999998      2497461    655360.00
       3.707     0.999999      2497461    748982.86
       3.721     0.999999      2497462    873813.33
       3.721     0.999999      2497462   1048576.00
       3.721     0.999999      2497462   1165084.44
       3.769     0.999999      2497463   1310720.00
       3.769     0.999999      2497463   1497965.71
       3.769     0.999999      2497463   1747626.67
       3.769     1.000000      2497463   2097152.00
       3.769     1.000000      2497463   2330168.89
       3.789     1.000000      2497464   2621440.00
       3.789     1.000000      2497464          inf
#[Mean    =        1.271, StdDeviation   =        0.592]
#[Max     =        3.788, Total count    =      2497464]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2998787 requests in 1.00m, 191.29MB read
Requests/sec:  49980.27
Transfer/sec:      3.19MB
```

Как мы видим в синхронной реализации запросы обрабатываются с использованием Selectors.
Handle request, send response и в целом обработка запроса занимают 67% CPU, при этом примерно 33% CPU - 
это метод SelectorImpl.lockAndDoSelect, который вызывает метод poll(), забирающий из
очереди запросов следующий запрос. \
Соответственно видим проблему запросы стоят в очереди, постараемся решить ее с помощью 
добавления асинхронности в наш Service.


### Асинхронная реализация

Добавим в нашу реализацию ThreadPoll.

Параметры для ThreadPoolExecutor:

Размер пула потоков зависит от типа задачи и характеристик системы:
Тестирование проводится на MacBook Pro (16-inch, 2019) Procesor 2,6 GHz 6-Core Intel Core i7
Если пул потоков слишком велик, большое количество потоков будет конкурировать за относительно меньший объем процессора и
ограниченные ресурсы памяти, что не только повлияет на производительность и приводит к чрезмерному потреблению памяти.
Слишком маленький пул потоков приведет к неполному использованию процессора.

![img.png](img.png)
![img_1.png](img_1.png)

Источник: [Java Concurrency In Practice, section 8.2 Sizing Thread Pools.](https://www.amazon.com/dp/0321349601)

CorePoolSize = N_cpu * U_cpu * (1 + W / С). \
Так как у нас много взаимодействия с диском,
рекомендуется брать U_cpu * (1 + W / С) примерно равное 2. Поэтому
CorePoolSize = Runtime.getRuntime().availableProcessors() * 2

#PUT

```
wrk2 -t 6 -c 64 -d 60s -R 50000 -s requests-wrk/put-requests.lua --latency http://localhost:42342
Running 1m test @ http://localhost:42342
6 threads and 64 connections
Thread calibration: mean lat.: 1.604ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.577ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.583ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.502ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.609ms, rate sampling interval: 10ms
Thread calibration: mean lat.: 1.508ms, rate sampling interval: 10ms
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     1.47ms    2.12ms  44.64ms   98.87%
Req/Sec     8.79k   696.60    19.67k    75.30%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    1.27ms
75.000%    1.71ms
90.000%    2.15ms
99.000%    3.85ms
99.900%   37.15ms
99.990%   41.06ms
99.999%   43.13ms
100.000%   44.67ms

Detailed Percentile spectrum:
Value   Percentile   TotalCount 1/(1-Percentile)

       0.045     0.000000            1         1.00
       0.588     0.100000       249786         1.11
       0.782     0.200000       499741         1.25
       0.949     0.300000       749793         1.43
       1.108     0.400000      1000075         1.67
       1.266     0.500000      1249507         2.00
       1.347     0.550000      1374994         2.22
       1.430     0.600000      1498920         2.50
       1.518     0.650000      1623717         2.86
       1.611     0.700000      1749014         3.33
       1.713     0.750000      1874150         4.00
       1.768     0.775000      1935593         4.44
       1.829     0.800000      1998866         5.00
       1.894     0.825000      2060671         5.71
       1.967     0.850000      2123215         6.67
       2.053     0.875000      2186342         8.00
       2.101     0.887500      2217634         8.89
       2.153     0.900000      2248396        10.00
       2.211     0.912500      2279167        11.43
       2.279     0.925000      2310695        13.33
       2.357     0.937500      2341484        16.00
       2.403     0.943750      2357190        17.78
       2.455     0.950000      2372825        20.00
       2.515     0.956250      2388208        22.86
       2.587     0.962500      2403914        26.67
       2.675     0.968750      2419466        32.00
       2.729     0.971875      2427408        35.56
       2.789     0.975000      2435054        40.00
       2.867     0.978125      2442900        45.71
       2.967     0.981250      2450642        53.33
       3.115     0.984375      2458438        64.00
       3.231     0.985938      2462353        71.11
       3.399     0.987500      2466246        80.00
       3.655     0.989062      2470159        91.43
       3.991     0.990625      2474036       106.67
       4.471     0.992188      2477932       128.00
       4.815     0.992969      2479887       142.22
       5.299     0.993750      2481846       160.00
       6.135     0.994531      2483788       182.86
       8.439     0.995313      2485737       213.33
      22.063     0.996094      2487686       256.00
      25.631     0.996484      2488664       284.44
      27.439     0.996875      2489640       320.00
      28.895     0.997266      2490618       365.71
      30.543     0.997656      2491602       426.67
      32.655     0.998047      2492569       512.00
      33.855     0.998242      2493051       568.89
      35.167     0.998437      2493539       640.00
      36.031     0.998633      2494033       731.43
      36.671     0.998828      2494521       853.33
      37.247     0.999023      2495029      1024.00
      37.535     0.999121      2495260      1137.78
      37.823     0.999219      2495501      1280.00
      38.143     0.999316      2495765      1462.86
      38.367     0.999414      2495991      1706.67
      38.687     0.999512      2496224      2048.00
      38.879     0.999561      2496347      2275.56
      39.039     0.999609      2496466      2560.00
      39.295     0.999658      2496594      2925.71
      39.551     0.999707      2496711      3413.33
      39.839     0.999756      2496839      4096.00
      39.999     0.999780      2496902      4551.11
      40.255     0.999805      2496963      5120.00
      40.447     0.999829      2497018      5851.43
      40.671     0.999854      2497079      6826.67
      40.863     0.999878      2497140      8192.00
      40.959     0.999890      2497171      9102.22
      41.087     0.999902      2497199     10240.00
      41.215     0.999915      2497229     11702.86
      41.375     0.999927      2497261     13653.33
      41.599     0.999939      2497291     16384.00
      41.727     0.999945      2497306     18204.44
      41.887     0.999951      2497320     20480.00
      42.047     0.999957      2497336     23405.71
      42.175     0.999963      2497352     27306.67
      42.367     0.999969      2497365     32768.00
      42.463     0.999973      2497375     36408.89
      42.495     0.999976      2497381     40960.00
      42.591     0.999979      2497388     46811.43
      42.751     0.999982      2497396     54613.33
      42.815     0.999985      2497405     65536.00
      42.847     0.999986      2497408     72817.78
      43.007     0.999988      2497411     81920.00
      43.039     0.999989      2497415     93622.86
      43.199     0.999991      2497420    109226.67
      43.231     0.999992      2497422    131072.00
      43.263     0.999993      2497424    145635.56
      43.327     0.999994      2497426    163840.00
      43.359     0.999995      2497428    187245.71
      43.487     0.999995      2497430    218453.33
      43.551     0.999996      2497432    262144.00
      43.679     0.999997      2497433    291271.11
      43.807     0.999997      2497434    327680.00
      43.839     0.999997      2497436    374491.43
      43.839     0.999998      2497436    436906.67
      43.935     0.999998      2497437    524288.00
      43.935     0.999998      2497437    582542.22
      43.999     0.999998      2497438    655360.00
      43.999     0.999999      2497438    748982.86
      44.191     0.999999      2497439    873813.33
      44.191     0.999999      2497439   1048576.00
      44.191     0.999999      2497439   1165084.44
      44.351     0.999999      2497440   1310720.00
      44.351     0.999999      2497440   1497965.71
      44.351     0.999999      2497440   1747626.67
      44.351     1.000000      2497440   2097152.00
      44.351     1.000000      2497440   2330168.89
      44.671     1.000000      2497441   2621440.00
      44.671     1.000000      2497441          inf
#[Mean    =        1.468, StdDeviation   =        2.123]
#[Max     =       44.640, Total count    =      2497441]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
2998772 requests in 1.00m, 191.61MB read
Requests/sec:  49979.90
Transfer/sec:      3.19MB
```