> В качестве БД была взята собственная БД с прошлого семестра.

PUT запросы на стабильной нагрузке к пустой БД:
-
> $ wrk -t 1 -c 1 -R 20000 -d 1m -s put.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

1 threads and 1 connections

Thread calibration: mean lat.: 1.010ms, rate sampling interval: 10ms

    Thread Stats   Avg      Stdev      Max   +/- Stdev
    Latency   828.07us     1.20ms  20.51ms      95.34%
    Req/Sec     21.09k      2.08k   56.78k      70.23%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%  650.00us
    75.000%    0.93ms
    90.000%    1.12ms
    99.000%    6.39ms
    99.900%   15.77ms
    99.990%   19.77ms
    99.999%   20.21ms
    100.000%  20.53ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.008     0.000000            3         1.00
       0.158     0.100000       100208         1.11
       0.285     0.200000       200113         1.25
       0.411     0.300000       300286         1.43
       0.533     0.400000       400003         1.67
       0.650     0.500000       500271         2.00
       0.707     0.550000       550423         2.22
       0.763     0.600000       600605         2.50
       0.818     0.650000       650432         2.86
       0.873     0.700000       700535         3.33
       0.928     0.750000       750760         4.00
       0.955     0.775000       775387         4.44
       0.982     0.800000       800098         5.00
       1.010     0.825000       825538         5.71
       1.037     0.850000       850511         6.67
       1.064     0.875000       875252         8.00
       1.078     0.887500       888243         8.89
       1.121     0.900000       899988        10.00
       1.292     0.912500       912410        11.43
       1.497     0.925000       924930        13.33
       1.711     0.937500       937408        16.00
       1.830     0.943750       943709        17.78
       1.957     0.950000       949931        20.00
       2.111     0.956250       956160        22.86
       2.381     0.962500       962408        26.67
       2.723     0.968750       968650        32.00
       2.975     0.971875       971780        35.56
       3.281     0.975000       974905        40.00
       3.703     0.978125       978025        45.71
       4.191     0.981250       981158        53.33
       4.703     0.984375       984284        64.00
       5.023     0.985938       985854        71.11
       5.459     0.987500       987407        80.00
       5.991     0.989062       988970        91.43
       6.643     0.990625       990527       106.67
       7.287     0.992188       992088       128.00
       7.559     0.992969       992872       142.22
       8.099     0.993750       993647       160.00
       8.911     0.994531       994431       182.86
       9.527     0.995313       995209       213.33
      10.055     0.996094       995991       256.00
      10.327     0.996484       996387       284.44
      10.879     0.996875       996777       320.00
      11.751     0.997266       997164       365.71
      12.295     0.997656       997553       426.67
      12.887     0.998047       997946       512.00
      13.359     0.998242       998140       568.89
      14.095     0.998437       998335       640.00
      14.847     0.998633       998530       731.43
      15.295     0.998828       998726       853.33
      15.799     0.999023       998920      1024.00
      16.087     0.999121       999018      1137.78
      16.415     0.999219       999118      1280.00
      16.607     0.999316       999237      1462.86
      17.135     0.999414       999311      1706.67
      17.951     0.999512       999409      2048.00
      18.303     0.999561       999457      2275.56
      18.607     0.999609       999506      2560.00
      18.911     0.999658       999556      2925.71
      19.151     0.999707       999604      3413.33
      19.359     0.999756       999657      4096.00
      19.423     0.999780       999684      4551.11
      19.455     0.999805       999702      5120.00
      19.535     0.999829       999727      5851.43
      19.615     0.999854       999751      6826.67
      19.695     0.999878       999775      8192.00
      19.743     0.999890       999791      9102.22
      19.775     0.999902       999804     10240.00
      19.791     0.999915       999812     11702.86
      19.823     0.999927       999825     13653.33
      19.839     0.999939       999840     16384.00
      19.871     0.999945       999842     18204.44
      19.919     0.999951       999851     20480.00
      19.951     0.999957       999856     23405.71
      19.967     0.999963       999861     27306.67
      19.999     0.999969       999869     32768.00
      19.999     0.999973       999869     36408.89
      20.015     0.999976       999872     40960.00
      20.047     0.999979       999875     46811.43
      20.079     0.999982       999878     54613.33
      20.111     0.999985       999881     65536.00
      20.127     0.999986       999883     72817.78
      20.143     0.999988       999884     81920.00
      20.207     0.999989       999886     93622.86
      20.239     0.999991       999887    109226.67
      20.319     0.999992       999889    131072.00
      20.367     0.999993       999890    145635.56
      20.367     0.999994       999890    163840.00
      20.399     0.999995       999891    187245.71
      20.431     0.999995       999892    218453.33
      20.463     0.999996       999893    262144.00
      20.463     0.999997       999893    291271.11
      20.463     0.999997       999893    327680.00
      20.495     0.999997       999894    374491.43
      20.495     0.999998       999894    436906.67
      20.527     0.999998       999896    524288.00
      20.527     1.000000       999896          inf
***
    #[Mean    =        0.828, StdDeviation   =        1.203]
    #[Max     =       20.512, Total count    =       999896]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
1199973 requests in 1.00m, 76.67MB read

Requests/sec:  19999.58

Transfer/sec:      1.28MB

---

> $ wrk -t 1 -c 1 -R 30000 -d 1m -s put.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

1 threads and 1 connections

Thread calibration: mean lat.: 2.111ms, rate sampling interval: 10ms

    Thread Stats   Avg      Stdev      Max   +/- Stdev
    Latency     2.33ms     6.06ms  88.00ms      92.93%
    Req/Sec     31.67k      6.96k  116.78k      86.84%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%  725.00us
    75.000%    1.04ms
    90.000%    5.31ms
    99.000%   31.14ms
    99.900%   72.45ms
    99.990%   87.81ms
    99.999%   88.00ms
    100.000%  88.06ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.009     0.000000            1         1.00
       0.170     0.100000       150667         1.11
       0.315     0.200000       300456         1.25
       0.457     0.300000       450788         1.43
       0.593     0.400000       600140         1.67
       0.725     0.500000       750512         2.00
       0.790     0.550000       825990         2.22
       0.853     0.600000       900173         2.50
       0.917     0.650000       975528         2.86
       0.980     0.700000      1050175         3.33
       1.043     0.750000      1125329         4.00
       1.075     0.775000      1162451         4.44
       1.364     0.800000      1199938         5.00
       1.800     0.825000      1237430         5.71
       2.491     0.850000      1274940         6.67
       3.629     0.875000      1312428         8.00
       4.391     0.887500      1331231         8.89
       5.311     0.900000      1349925        10.00
       6.435     0.912500      1368667        11.43
       7.831     0.925000      1387445        13.33
       9.479     0.937500      1406180        16.00
      10.311     0.943750      1415568        17.78
      11.439     0.950000      1424905        20.00
      12.999     0.956250      1434294        22.86
      14.799     0.962500      1443669        26.67
      16.479     0.968750      1453044        32.00
      17.535     0.971875      1457724        35.56
      18.799     0.975000      1462404        40.00
      20.223     0.978125      1467108        45.71
      21.871     0.981250      1471815        53.33
      24.847     0.984375      1476475        64.00
      26.623     0.985938      1478804        71.11
      28.175     0.987500      1481160        80.00
      30.031     0.989062      1483511        91.43
      31.999     0.990625      1485838       106.67
      34.175     0.992188      1488203       128.00
      35.743     0.992969      1489348       142.22
      37.055     0.993750      1490609       160.00
      39.199     0.994531      1491704       182.86
      41.791     0.995313      1492872       213.33
      44.511     0.996094      1494044       256.00
      45.695     0.996484      1494638       284.44
      47.199     0.996875      1495208       320.00
      49.311     0.997266      1495797       365.71
      51.711     0.997656      1496393       426.67
      53.407     0.998047      1496965       512.00
      56.287     0.998242      1497258       568.89
      60.383     0.998437      1497552       640.00
      65.023     0.998633      1497845       731.43
      69.375     0.998828      1498140       853.33
      72.831     0.999023      1498431      1024.00
      74.751     0.999121      1498579      1137.78
      76.991     0.999219      1498727      1280.00
      78.975     0.999316      1498872      1462.86
      81.023     0.999414      1499019      1706.67
      82.815     0.999512      1499164      2048.00
      83.711     0.999561      1499237      2275.56
      84.607     0.999609      1499314      2560.00
      85.439     0.999658      1499386      2925.71
      86.207     0.999707      1499457      3413.33
      86.719     0.999756      1499534      4096.00
      86.911     0.999780      1499565      4551.11
      87.167     0.999805      1499606      5120.00
      87.359     0.999829      1499645      5851.43
      87.551     0.999854      1499687      6826.67
      87.679     0.999878      1499715      8192.00
      87.743     0.999890      1499735      9102.22
      87.807     0.999902      1499761     10240.00
      87.871     0.999915      1499789     11702.86
      87.871     0.999927      1499789     13653.33
      87.935     0.999939      1499823     16384.00
      87.935     0.999945      1499823     18204.44
      87.935     0.999951      1499823     20480.00
      87.999     0.999957      1499893     23405.71
      87.999     0.999963      1499893     27306.67
      87.999     0.999969      1499893     32768.00
      87.999     0.999973      1499893     36408.89
      87.999     0.999976      1499893     40960.00
      87.999     0.999979      1499893     46811.43
      87.999     0.999982      1499893     54613.33
      87.999     0.999985      1499893     65536.00
      87.999     0.999986      1499893     72817.78
      87.999     0.999988      1499893     81920.00
      87.999     0.999989      1499893     93622.86
      87.999     0.999991      1499893    109226.67
      87.999     0.999992      1499893    131072.00
      87.999     0.999993      1499893    145635.56
      87.999     0.999994      1499893    163840.00
      87.999     0.999995      1499893    187245.71
      87.999     0.999995      1499893    218453.33
      87.999     0.999996      1499893    262144.00
      87.999     0.999997      1499893    291271.11
      87.999     0.999997      1499893    327680.00
      87.999     0.999997      1499893    374491.43
      87.999     0.999998      1499893    436906.67
      87.999     0.999998      1499893    524288.00
      87.999     0.999998      1499893    582542.22
      87.999     0.999998      1499893    655360.00
      87.999     0.999999      1499893    748982.86
      87.999     0.999999      1499893    873813.33
      87.999     0.999999      1499893   1048576.00
      87.999     0.999999      1499893   1165084.44
      87.999     0.999999      1499893   1310720.00
      87.999     0.999999      1499893   1497965.71
      88.063     0.999999      1499894   1747626.67
      88.063     1.000000      1499894          inf
***
    #[Mean    =        2.332, StdDeviation   =        6.062]
    #[Max     =       88.000, Total count    =      1499894]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
1799958 requests in 1.00m, 115.01MB read

Requests/sec:  29999.46

Transfer/sec:      1.92MB

> Хит мап и флейм граф в файлах put_alloc.html и put_cpu.html.

GET запросы на стабильной нагрузке к наполненной БД:
-
> Было добавлено 1_000_000 записей в БД перед тестированием

> $ wrk -t 1 -c 1 -R 80000 -d 1m -s get.lua -L http://localhost:19234

Running 1m test @ http://localhost:19234

1 threads and 1 connections

Thread calibration: mean lat.: 2.996ms, rate sampling interval: 15ms

    Thread Stats   Avg      Stdev      Max   +/- Stdev
    Latency     2.11ms     3.14ms  28.10ms      88.41%
    Req/Sec     82.67k      9.63k  114.93k      75.01%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    0.86ms
    75.000%    2.29ms
    90.000%    5.82ms
    99.000%   15.04ms
    99.900%   23.01ms
    99.990%   27.47ms
    99.999%   28.03ms
    100.000%  28.11ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.008     0.000000          224         1.00
       0.196     0.100000       401632         1.11
       0.373     0.200000       800398         1.25
       0.543     0.300000      1202057         1.43
       0.705     0.400000      1599997         1.67
       0.864     0.500000      2000700         2.00
       0.942     0.550000      2201323         2.22
       1.018     0.600000      2399593         2.50
       1.211     0.650000      2599488         2.86
       1.652     0.700000      2799636         3.33
       2.285     0.750000      2999576         4.00
       2.667     0.775000      3099777         4.44
       3.109     0.800000      3199461         5.00
       3.613     0.825000      3299408         5.71
       4.207     0.850000      3399776         6.67
       4.951     0.875000      3499586         8.00
       5.363     0.887500      3549477         8.89
       5.823     0.900000      3599599        10.00
       6.399     0.912500      3649280        11.43
       7.099     0.925000      3699323        13.33
       7.895     0.937500      3749374        16.00
       8.327     0.943750      3774494        17.78
       8.767     0.950000      3799293        20.00
       9.295     0.956250      3824257        22.86
      10.079     0.962500      3849307        26.67
      11.047     0.968750      3874308        32.00
      11.551     0.971875      3886821        35.56
      12.111     0.975000      3899205        40.00
      12.727     0.978125      3911774        45.71
      13.287     0.981250      3924266        53.33
      13.887     0.984375      3936741        64.00
      14.159     0.985938      3942943        71.11
      14.455     0.987500      3949302        80.00
      14.783     0.989062      3955492        91.43
      15.247     0.990625      3961710       106.67
      15.823     0.992188      3967975       128.00
      16.183     0.992969      3971126       142.22
      16.575     0.993750      3974227       160.00
      16.895     0.994531      3977383       182.86
      17.311     0.995313      3980467       213.33
      18.255     0.996094      3983579       256.00
      18.799     0.996484      3985121       284.44
      19.135     0.996875      3986710       320.00
      19.487     0.997266      3988254       365.71
      19.919     0.997656      3989813       426.67
      20.543     0.998047      3991403       512.00
      20.831     0.998242      3992170       568.89
      21.247     0.998437      3992959       640.00
      21.759     0.998633      3993716       731.43
      22.415     0.998828      3994496       853.33
      23.055     0.999023      3995276      1024.00
      23.375     0.999121      3995665      1137.78
      24.191     0.999219      3996060      1280.00
      24.975     0.999316      3996445      1462.86
      25.391     0.999414      3996836      1706.67
      25.903     0.999512      3997231      2048.00
      26.191     0.999561      3997421      2275.56
      26.479     0.999609      3997622      2560.00
      26.687     0.999658      3997830      2925.71
      26.863     0.999707      3998021      3413.33
      26.991     0.999756      3998236      4096.00
      27.023     0.999780      3998312      4551.11
      27.087     0.999805      3998420      5120.00
      27.135     0.999829      3998496      5851.43
      27.215     0.999854      3998598      6826.67
      27.359     0.999878      3998696      8192.00
      27.439     0.999890      3998747      9102.22
      27.487     0.999902      3998804     10240.00
      27.535     0.999915      3998837     11702.86
      27.615     0.999927      3998888     13653.33
      27.695     0.999939      3998934     16384.00
      27.743     0.999945      3998967     18204.44
      27.775     0.999951      3998988     20480.00
      27.807     0.999957      3999013     23405.71
      27.839     0.999963      3999037     27306.67
      27.871     0.999969      3999061     32768.00
      27.887     0.999973      3999072     36408.89
      27.903     0.999976      3999081     40960.00
      27.935     0.999979      3999093     46811.43
      27.967     0.999982      3999105     54613.33
      27.999     0.999985      3999124     65536.00
      27.999     0.999986      3999124     72817.78
      28.015     0.999988      3999136     81920.00
      28.015     0.999989      3999136     93622.86
      28.031     0.999991      3999143    109226.67
      28.047     0.999992      3999150    131072.00
      28.047     0.999993      3999150    145635.56
      28.063     0.999994      3999158    163840.00
      28.063     0.999995      3999158    187245.71
      28.079     0.999995      3999165    218453.33
      28.079     0.999996      3999165    262144.00
      28.079     0.999997      3999165    291271.11
      28.079     0.999997      3999165    327680.00
      28.095     0.999997      3999173    374491.43
      28.095     0.999998      3999173    436906.67
      28.095     0.999998      3999173    524288.00
      28.095     0.999998      3999173    582542.22
      28.095     0.999998      3999173    655360.00
      28.095     0.999999      3999173    748982.86
      28.095     0.999999      3999173    873813.33
      28.111     0.999999      3999177   1048576.00
      28.111     1.000000      3999177          inf
***
    #[Mean    =        2.105, StdDeviation   =        3.139]
    #[Max     =       28.096, Total count    =      3999177]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
4799348 requests in 1.00m, 315.81MB read

Non-2xx or 3xx responses: 4799348

Requests/sec:  79989.61

Transfer/sec:      5.26MB

---

> $ wrk -t 1 -c 1 -R 90000 -d 1m -s get.lua -L http://localhost:19234
> 

Running 1m test @ http://localhost:19234

1 threads and 1 connections

Thread calibration: mean lat.: 11.754ms, rate sampling interval: 59ms

    Thread Stats   Avg      Stdev      Max   +/- Stdev
    Latency    29.91ms    27.64ms 158.59ms      70.97%
    Req/Sec     90.78k      9.05k  107.00k      67.77%
***
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%   24.35ms
    75.000%   43.10ms
    90.000%   65.60ms
    99.000%  131.58ms
    99.900%  154.49ms
    99.990%  158.21ms
    99.999%  158.72ms
    100.000% 158.72ms

Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.008     0.000000           63         1.00
       1.018     0.100000       449999         1.11
       5.183     0.200000       900078         1.25
      10.975     0.300000      1350024         1.43
      17.407     0.400000      1800553         1.67
      24.351     0.500000      2250855         2.00
      27.551     0.550000      2475064         2.22
      30.559     0.600000      2700013         2.50
      34.559     0.650000      2926693         2.86
      38.591     0.700000      3149932         3.33
      43.103     0.750000      3375243         4.00
      45.951     0.775000      3488556         4.44
      49.727     0.800000      3600394         5.00
      53.567     0.825000      3712670         5.71
      57.279     0.850000      3825788         6.67
      60.831     0.875000      3937686         8.00
      63.519     0.887500      3993656         8.89
      65.599     0.900000      4050328        10.00
      67.839     0.912500      4106698        11.43
      70.847     0.925000      4163000        13.33
      74.047     0.937500      4219047        16.00
      75.583     0.943750      4246919        17.78
      78.783     0.950000      4275187        20.00
      83.839     0.956250      4303116        22.86
      88.319     0.962500      4331239        26.67
      94.783     0.968750      4359241        32.00
     101.247     0.971875      4373427        35.56
     105.343     0.975000      4387404        40.00
     113.471     0.978125      4401436        45.71
     116.159     0.981250      4415551        53.33
     118.079     0.984375      4429559        64.00
     119.359     0.985938      4436671        71.11
     122.751     0.987500      4443684        80.00
     128.703     0.989062      4450672        91.43
     132.479     0.990625      4457959       106.67
     135.039     0.992188      4464743       128.00
     137.727     0.992969      4468265       142.22
     141.439     0.993750      4471974       160.00
     143.359     0.994531      4475398       182.86
     145.023     0.995313      4478940       213.33
     146.559     0.996094      4482298       256.00
     147.327     0.996484      4484363       284.44
     148.095     0.996875      4485904       320.00
     148.991     0.997266      4487564       365.71
     149.887     0.997656      4489324       426.67
     150.783     0.998047      4491193       512.00
     151.295     0.998242      4492023       568.89
     152.319     0.998437      4492863       640.00
     153.215     0.998633      4493886       731.43
     153.599     0.998828      4494593       853.33
     154.623     0.999023      4495464      1024.00
     155.135     0.999121      4495933      1137.78
     155.647     0.999219      4496409      1280.00
     156.031     0.999316      4496953      1462.86
     156.287     0.999414      4497252      1706.67
     156.799     0.999512      4497829      2048.00
     156.927     0.999561      4498033      2275.56
     157.055     0.999609      4498244      2560.00
     157.183     0.999658      4498460      2925.71
     157.311     0.999707      4498579      3413.33
     157.567     0.999756      4498808      4096.00
     157.695     0.999780      4498945      4551.11
     157.823     0.999805      4499099      5120.00
     157.823     0.999829      4499099      5851.43
     157.951     0.999854      4499235      6826.67
     158.079     0.999878      4499348      8192.00
     158.207     0.999890      4499457      9102.22
     158.207     0.999902      4499457     10240.00
     158.335     0.999915      4499561     11702.86
     158.335     0.999927      4499561     13653.33
     158.463     0.999939      4499668     16384.00
     158.463     0.999945      4499668     18204.44
     158.463     0.999951      4499668     20480.00
     158.463     0.999957      4499668     23405.71
     158.591     0.999963      4499767     27306.67
     158.591     0.999969      4499767     32768.00
     158.591     0.999973      4499767     36408.89
     158.591     0.999976      4499767     40960.00
     158.591     0.999979      4499767     46811.43
     158.591     0.999982      4499767     54613.33
     158.719     0.999985      4499845     65536.00
     158.719     1.000000      4499845          inf
***
    #[Mean    =       29.910, StdDeviation   =       27.639]
    #[Max     =      158.592, Total count    =      4499845]
    #[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
5399790 requests in 1.00m, 355.33MB read

Non-2xx or 3xx responses: 5399790

Requests/sec:  89996.70

Transfer/sec:      5.92MB

> Хит мап и флейм граф в файлах get_alloc.html и get_cpu.html.

Выводы:
-
Put:

Скорость обработки поступающих запросов в обычном режиме составляет примерно 20000 r/s. При этом latency в среднем

составляет примерно 0.83ms. 90% запросов выполняются за 1.12ms в среднем, а 99% - за 15.04ms. При скорости обработки

запросов в 30000 r/s и более сервис начинает тормозить и latency в среднем составляет уже примерно 2.3ms и будет

постепенно увеличиваться. 90% запросов при такой скорости выполняются за 5.31ms в среднем, а 99% - уже за 31.14ms.

Процессорное время делится следующим образом: примерно 40% времени занимает работа библиотеки one-nio, еще около 35% -

обмен информации по протоколу tcp/ip. Оставшиеся 25% - выполнение методов самой БД (поиск в таблицах, выделение памяти

и т. д.).

Память по большей части (приблизительно 95%) выделяется под библиотеку one-nio. Эта память расходуется на создание

сессий, обработку http request/response. Оставшаяся память (приблизительно 5%) выделяется под парсинг строк (для

получения id, например), копирование массивов и т. п.


Get:

Скорость обработки поступающих запросов в обычном режиме составляет примерно 80000 r/s. При этом latency в среднем

составляет примерно 2.11ms. 90% запросов выполняются за 5.82s в среднем, а 99% - за 6.39ms. При скорости обработки

запросов в 90000 r/s и более сервис начинает тормозить и latency в среднем составляет уже примерно 29.91ms и будет

постепенно увеличиваться. 90% запросов при такой скорости выполняются за 65.60ms в среднем, а 99% - уже за 131.68ms.

Процессорное время делится следующим образом: примерно 55% времени занимает работа по поиску записей в БД, еще около

25% - обмен информации по протоколу tcp/ip. Также 20% - работа библиотеки one-nio.

Приблизительно 50% памяти расходуется на библиотеку one-nio. Здесь необходимо создать сессию, обработать http

request/response, буферизировать полученные данные. Кроме того, оставшаяся память (приблизительно 50%) расходуется на

работу БД, а именно поиск записей, merge найденных записей из разных таблиц.

