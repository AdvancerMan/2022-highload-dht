# wrk

## Скрипт wrk
по мотивам https://github.com/wg/wrk/blob/master/scripts/counter.lua:
```lua
counter = 0

request = function()
    path = "/v0/entity?id=keyNumber" .. counter
    wrk.method = "PUT"
    wrk.body = string.rep("Pneumonoultramicroscopicsilicovolcanoconiosis!", 15)
    counter = counter + 1
    return wrk.format("PUT", path)
end
```

## Тестирование при размере блока 1МБ
### Заполнение пустой базы при помощи `PUT`
#### Первый прогон на пустой базе
```text
./wrk -c 1 -t 1 -R 30000 -d 10  -s ~/study-files/highload/lua/put.lua http://localhost:19234

Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    10.99ms   32.66ms 153.22ms   91.01%
    Req/Sec       -nan      -nan   0.00      0.00%
  299972 requests in 10.00s, 19.17MB read
Requests/sec:  29998.54
Transfer/sec:      1.92MB
```

Не так уж и быстро, но для 30k RPS -- приемлемо. Попробуем перезаписать ключи, которые уже есть в базе.

#### Повторный прогон на заполненной базе
```text
./wrk -c 1 -t 1 -R 30000 -d 10  -s ~/study-files/highload/lua/put.lua http://localhost:19234

Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   746.05us    0.96ms  15.34ms   97.35%
    Req/Sec       -nan      -nan   0.00      0.00%
  299941 requests in 10.00s, 19.17MB read
Requests/sec:  29995.55
Transfer/sec:      1.92MB
```

Укладываемся в 1ms.

#### Прогон с 50k RPS
```text
./wrk -c 1 -t 1 -R 50000 -d 10  -s ~/study-files/highload/lua/put.lua http://localhost:19234

Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   499.35ms  276.55ms 956.93ms   54.06%
    Req/Sec       -nan      -nan   0.00      0.00%
  452105 requests in 10.00s, 28.89MB read
Requests/sec:  45212.62
Transfer/sec:      2.89MB
```
Захлебнулись.

### Чтение заполненной базы при помощи `GET`

#### Первый прогон 3k RPS
```text
./wrk -c 1 -t 1 -R 3000 -d 10  -s ~/study-files/highload/lua/get.lua http://localhost:19234

Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    10.15ms   33.36ms 242.05ms   95.03%
    Req/Sec       -nan      -nan   0.00      0.00%
  29996 requests in 10.00s, 21.57MB read
Requests/sec:   2999.40
Transfer/sec:      2.16MB
```

#### Второй прогон 3k RPS

```text
./wrk -c 1 -t 1 -R 3000 -d 10  -s ~/study-files/highload/lua/get.lua http://localhost:19234

Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.86ms    7.45ms  44.35ms   89.35%
    Req/Sec       -nan      -nan   0.00      0.00%
  29998 requests in 10.00s, 21.57MB read
Requests/sec:   2999.71
Transfer/sec:      2.16MB
```

Пока живём!

#### Прогоны 10k RPS

```text
./wrk -c 1 -t 1 -R 10000 -d 10  -s ~/study-files/highload/lua/get.lua http://localhost:19234

Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   827.19ms  339.90ms   1.17s    77.08%
    Req/Sec       -nan      -nan   0.00      0.00%
  88806 requests in 10.00s, 63.86MB read
Requests/sec:   8880.62
Transfer/sec:      6.39MB
```

Захлебнулись. Давайте попробуем повысить размер блока до 8МБ

## Тестирование при размере блока 8МБ
### Заполнение пустой базы при помощи `PUT`
#### Первый прогон на пустой базе
```text
./wrk -c 1 -t 1 -R 30000 -d 10  -s ~/study-files/highload/lua/put.lua http://localhost:19234

Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     7.24ms   22.33ms 113.79ms   91.84%
    Req/Sec       -nan      -nan   0.00      0.00%
  299964 requests in 10.00s, 19.17MB read
Requests/sec:  29997.90
Transfer/sec:      1.92MB
```

```text
./wrk -c 1 -t 1 -R 30000 -d 10  -s ~/study-files/highload/lua/put.lua http://localhost:19234
Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.11ms    1.83ms  14.75ms   93.89%
    Req/Sec       -nan      -nan   0.00      0.00%
  299960 requests in 10.00s, 19.17MB read
Requests/sec:  29997.59
Transfer/sec:      1.92MB
```
### Чтение заполненной базы при помощи `GET`

#### Первый прогон 10k RPS
```text
./wrk -c 1 -t 1 -R 10000 -d 10  -s ~/study-files/highload/lua/get.lua http://localhost:19234

Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    10.04ms   36.50ms 242.05ms   94.50%
    Req/Sec       -nan      -nan   0.00      0.00%
  99981 requests in 10.00s, 71.89MB read
Requests/sec:   9998.72
Transfer/sec:      7.19MB
```

#### Второй прогон 10k RPS

```text
./wrk -c 1 -t 1 -R 10000 -d 10  -s ~/study-files/highload/lua/get.lua http://localhost:19234

Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.49ms    3.47ms  43.90ms   94.79%
    Req/Sec       -nan      -nan   0.00      0.00%
  99980 requests in 10.00s, 71.89MB read
Requests/sec:   9997.67
Transfer/sec:      7.19MB
```

Пока живём!

#### 20k RPS
```text
./wrk -c 1 -t 1 -R 20000 -d 10  -s ~/study-files/highload/lua/get.lua http://localhost:19234

Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.00ms   12.98ms  69.18ms   94.24%
    Req/Sec       -nan      -nan   0.00      0.00%
  199976 requests in 10.00s, 143.80MB read
Requests/sec:  19998.65
Transfer/sec:     14.38MB
```
Не упали, повышаем нагрузку.
#### 30k RPS
```text

./wrk -c 1 -t 1 -R 30000 -d 10  -s ~/study-files/highload/lua/get.lua http://localhost:19234
Running 10s test @ http://localhost:19234
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   788.24ms  217.04ms 984.06ms   84.70%
    Req/Sec       -nan      -nan   0.00      0.00%
  280125 requests in 10.00s, 201.43MB read
Requests/sec:  28013.83
Transfer/sec:     20.14MB
```
Смерть.