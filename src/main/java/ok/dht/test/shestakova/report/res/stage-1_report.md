### **STAGE 1**

Для выполнения работы была использована своя реализацию DAO из весеннего курса 2022-nosql-lsm.

#### **Нагрузочное тестирование**
##### PUT-запросы
Для определения стабильной нагрузки параметр -R (rate) варьировался следующим образом: { 1000, 10000, 20000, 30000, 40000, 50000 }.
Среднее значение latency при искомом параметре, равном 50000, достигало 1.94 с, при 46000 - 2.89 мс, а при 40000 - менее одной миллисекунды. Таким образом было выбрано значение rate = 45000, при котором интересующий нас параметр latency avg стал принимать значение 0.96 мс.
На 90% запросов затрачивалось не более 1.88 мс при rate = 46000, 7.16 мс при rate = 50000, из чего можно сделать вывод о том, что первый вариант можно считать рабочей нагрузкой.

`wrk -t 1 -c 1 -d 1m -R 45000 -s put.lua -L http://localhost:19234`

Running 1m test @ http://localhost:19234  
  1 threads and 1 connections  
  Thread calibration: mean lat.: 65.427ms, rate sampling interval: 289ms  
  Thread Stats   Avg      Stdev     Max   +/- Stdev  
    Latency     0.96ms    1.13ms  10.56ms   91.13%  
    Req/Sec    37.41k    16.87k   46.15k    83.24%  
  Latency Distribution (HdrHistogram - Recorded Latency)  
 50.000%  711.00us  
 75.000%    1.02ms  
 90.000%    1.88ms  
 99.000%    6.23ms  
 99.900%    9.87ms  
 99.990%   10.38ms  
 99.999%   10.53ms  
100.000%   10.57ms  

  Detailed Percentile spectrum:  
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.018     0.000000            2         1.00
       0.178     0.100000       186967         1.11
       0.321     0.200000       373849         1.25
       0.454     0.300000       561273         1.43
       0.584     0.400000       747714         1.67
       0.711     0.500000       933660         2.00
       0.775     0.550000      1027661         2.22
       0.838     0.600000      1121273         2.50
       0.899     0.650000      1213409         2.86
       0.960     0.700000      1306959         3.33
       1.020     0.750000      1400331         4.00
       1.050     0.775000      1447244         4.44
       1.082     0.800000      1493445         5.00
       1.178     0.825000      1540257         5.71
       1.297     0.850000      1586646         6.67
       1.493     0.875000      1633467         8.00
       1.636     0.887500      1656667         8.89
       1.876     0.900000      1680034        10.00
       2.115     0.912500      1703413        11.43
       2.417     0.925000      1726649        13.33
       2.691     0.937500      1750109        16.00
       2.817     0.943750      1761824        17.78
       3.001     0.950000      1773343        20.00
       3.197     0.956250      1785044        22.86
       3.419     0.962500      1796657        26.67
       3.703     0.968750      1808300        32.00
       3.871     0.971875      1814177        35.56
       4.055     0.975000      1819993        40.00
       4.307     0.978125      1825877        45.71
       4.615     0.981250      1831662        53.33
       5.187     0.984375      1837511        64.00
       5.419     0.985938      1840395        71.11
       5.675     0.987500      1843322        80.00
       5.951     0.989062      1846234        91.43
       6.491     0.990625      1849133       106.67
       7.291     0.992188      1852060       128.00
       7.623     0.992969      1853522       142.22
       7.887     0.993750      1855024       160.00
       8.159     0.994531      1856431       182.86
       8.439     0.995313      1857929       213.33
       8.727     0.996094      1859375       256.00
       8.879     0.996484      1860098       284.44
       9.087     0.996875      1860807       320.00
       9.255     0.997266      1861554       365.71
       9.431     0.997656      1862292       426.67
       9.623     0.998047      1863043       512.00
       9.671     0.998242      1863397       568.89
       9.719     0.998437      1863715       640.00
       9.783     0.998633      1864138       731.43
       9.831     0.998828      1864475       853.33
       9.871     0.999023      1864831      1024.00
       9.887     0.999121      1865033      1137.78
       9.903     0.999219      1865185      1280.00
       9.927     0.999316      1865412      1462.86
       9.943     0.999414      1865595      1706.67
       9.975     0.999512      1865746      2048.00
       9.991     0.999561      1865854      2275.56
      10.007     0.999609      1865935      2560.00
      10.031     0.999658      1866005      2925.71
      10.071     0.999707      1866094      3413.33
      10.127     0.999756      1866183      4096.00
      10.167     0.999780      1866226      4551.11
      10.199     0.999805      1866278      5120.00
      10.239     0.999829      1866316      5851.43
      10.311     0.999854      1866359      6826.67
      10.351     0.999878      1866426      8192.00
      10.351     0.999890      1866426      9102.22
      10.383     0.999902      1866451     10240.00
      10.415     0.999915      1866473     11702.86
      10.455     0.999927      1866498     13653.33
      10.471     0.999939      1866524     16384.00
      10.479     0.999945      1866537     18204.44
      10.487     0.999951      1866567     20480.00
      10.487     0.999957      1866567     23405.71
      10.487     0.999963      1866567     27306.67
      10.495     0.999969      1866585     32768.00
      10.495     0.999973      1866585     36408.89
      10.503     0.999976      1866591     40960.00
      10.511     0.999979      1866597     46811.43
      10.511     0.999982      1866597     54613.33
      10.519     0.999985      1866603     65536.00
      10.527     0.999986      1866608     72817.78
      10.535     0.999988      1866613     81920.00
      10.535     0.999989      1866613     93622.86
      10.543     0.999991      1866619    109226.67
      10.543     0.999992      1866619    131072.00
      10.543     0.999993      1866619    145635.56
      10.551     0.999994      1866624    163840.00
      10.551     0.999995      1866624    187245.71
      10.551     0.999995      1866624    218453.33
      10.551     0.999996      1866624    262144.00
      10.559     0.999997      1866629    291271.11
      10.559     0.999997      1866629    327680.00
      10.559     0.999997      1866629    374491.43
      10.559     0.999998      1866629    436906.67
      10.559     0.999998      1866629    524288.00
      10.559     0.999998      1866629    582542.22
      10.559     0.999998      1866629    655360.00
      10.559     0.999999      1866629    748982.86
      10.559     0.999999      1866629    873813.33
      10.567     0.999999      1866631   1048576.00
      10.567     1.000000      1866631          inf
[Mean    =        0.959, StdDeviation   =        1.131]

[Max     =       10.560, Total count    =      1866631]

[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------

`wrk -t 1 -c 1 -d 1m -R 46000 -s put.lua -L http://localhost:19234`

Running 1m test @ http://localhost:19234  
  1 threads and 1 connections  
  Thread calibration: mean lat.: 114.967ms, rate sampling interval: 341ms  
  Thread Stats   Avg      Stdev     Max   +/- Stdev  
    Latency     2.89ms    5.40ms  35.62ms   90.94%  
    Req/Sec    24.56k    22.95k   47.71k    52.74%  
  Latency Distribution (HdrHistogram - Recorded Latency)  
 50.000%    0.90ms  
 75.000%    2.43ms  
 90.000%    7.16ms  
 99.000%   28.01ms  
 99.900%   34.91ms  
 99.990%   35.58ms  
 99.999%   35.65ms  
100.000%   35.65ms  

  Detailed Percentile spectrum:  
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.018     0.000000            7         1.00
       0.230     0.100000       122552         1.11
       0.410     0.200000       244944         1.25
       0.573     0.300000       366508         1.43
       0.736     0.400000       488598         1.67
       0.896     0.500000       611162         2.00
       0.975     0.550000       671910         2.22
       1.050     0.600000       732776         2.50
       1.205     0.650000       793878         2.86
       1.623     0.700000       854926         3.33
       2.431     0.750000       916025         4.00
       2.803     0.775000       946491         4.44
       3.247     0.800000       977055         5.00
       3.745     0.825000      1007594         5.71
       4.543     0.850000      1038095         6.67
       5.739     0.875000      1068571         8.00
       6.291     0.887500      1083859         8.89
       7.163     0.900000      1099114        10.00
       9.431     0.912500      1114367        11.43
      11.663     0.925000      1129670        13.33
      13.263     0.937500      1145029        16.00
      14.031     0.943750      1152535        17.78
      15.191     0.950000      1160190        20.00
      16.671     0.956250      1167840        22.86
      18.255     0.962500      1175593        26.67
      20.175     0.968750      1183147        32.00
      21.055     0.971875      1186912        35.56
      22.191     0.975000      1190873        40.00
      22.511     0.978125      1194533        45.71
      23.327     0.981250      1198377        53.33
      24.399     0.984375      1202152        64.00
      25.935     0.985938      1204055        71.11
      26.959     0.987500      1205996        80.00
      27.679     0.989062      1207909        91.43
      28.463     0.990625      1209780       106.67
      29.791     0.992188      1211700       128.00
      30.159     0.992969      1212646       142.22
      30.719     0.993750      1213622       160.00
      30.991     0.994531      1214612       182.86
      31.183     0.995313      1215559       213.33
      31.455     0.996094      1216481       256.00
      31.695     0.996484      1216937       284.44
      32.207     0.996875      1217431       320.00
      32.799     0.997266      1217896       365.71
      33.375     0.997656      1218410       426.67
      33.855     0.998047      1218885       512.00
      34.047     0.998242      1219084       568.89
      34.271     0.998437      1219323       640.00
      34.527     0.998633      1219563       731.43
      34.719     0.998828      1219814       853.33
      34.943     0.999023      1220057      1024.00
      35.071     0.999121      1220220      1137.78
      35.135     0.999219      1220282      1280.00
      35.199     0.999316      1220388      1462.86
      35.327     0.999414      1220560      1706.67
      35.423     0.999512      1220692      2048.00
      35.423     0.999561      1220692      2275.56
      35.455     0.999609      1220765      2560.00
      35.487     0.999658      1220819      2925.71
      35.519     0.999707      1220912      3413.33
      35.551     0.999756      1221069      4096.00
      35.551     0.999780      1221069      4551.11
      35.551     0.999805      1221069      5120.00
      35.551     0.999829      1221069      5851.43
      35.551     0.999854      1221069      6826.67
      35.583     0.999878      1221142      8192.00
      35.583     0.999890      1221142      9102.22
      35.583     0.999902      1221142     10240.00
      35.583     0.999915      1221142     11702.86
      35.583     0.999927      1221142     13653.33
      35.615     0.999939      1221191     16384.00
      35.615     0.999945      1221191     18204.44
      35.615     0.999951      1221191     20480.00
      35.615     0.999957      1221191     23405.71
      35.615     0.999963      1221191     27306.67
      35.615     0.999969      1221191     32768.00
      35.615     0.999973      1221191     36408.89
      35.647     0.999976      1221222     40960.00
      35.647     1.000000      1221222          inf
[Mean    =        2.887, StdDeviation   =        5.405]

[Max     =       35.616, Total count    =      1221222]

[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------

##### GET-запросы на заполненной (~1000000 записей) БД
Для определения стабильной нагрузки параметр -R (rate) варьировался следующим образом: { 1000, 2000, 3000, 4000, 5000, 6000, 10000 }.
Среднее значение latency при искомом параметре, равном 10000, достигало 2.76 с, при 6000 - 1.10 мс, а **при 5000 - 0.86 мс**.
На 90% запросов затрачивалось не более 1.29 мс при rate = 5000, 2.0 мс при rate = 6000, из чего можно сделать вывод о том, что первый вариант можно считать рабочей нагрузкой.

`wrk -t 1 -c 1 -d 60 -R 5000 -s get.lua -L http://localhost:19234`  
Running 1m test @ http://localhost:19234  
1 threads and 1 connections  
Thread calibration: mean lat.: 0.865ms, rate sampling interval: 10ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     0.86ms  614.42us  10.82ms   83.27%  
Req/Sec     5.28k   416.60     7.70k    77.72%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%  784.00us  
75.000%    1.09ms  
90.000%    1.39ms  
99.000%    3.36ms  
99.900%    5.97ms  
99.990%    8.18ms  
99.999%   10.53ms  
100.000%   10.82ms  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.033     0.000000            1         1.00
       0.277     0.100000        25020         1.11
       0.406     0.200000        50088         1.25
       0.534     0.300000        75169         1.43
       0.660     0.400000       100077         1.67
       0.784     0.500000       125203         2.00
       0.846     0.550000       137520         2.22
       0.907     0.600000       150084         2.50
       0.967     0.650000       162491         2.86
       1.027     0.700000       175034         3.33
       1.086     0.750000       187679         4.00
       1.115     0.775000       193929         4.44
       1.144     0.800000       200156         5.00
       1.173     0.825000       206240         5.71
       1.204     0.850000       212640         6.67
       1.238     0.875000       218777         8.00
       1.292     0.887500       221867         8.89
       1.389     0.900000       225015        10.00
       1.495     0.912500       228127        11.43
       1.608     0.925000       231243        13.33
       1.730     0.937500       234359        16.00
       1.795     0.943750       235921        17.78
       1.860     0.950000       237486        20.00
       1.933     0.956250       239042        22.86
       2.012     0.962500       240603        26.67
       2.139     0.968750       242166        32.00
       2.241     0.971875       242949        35.56
       2.367     0.975000       243737        40.00
       2.505     0.978125       244518        45.71
       2.655     0.981250       245292        53.33
       2.849     0.984375       246074        64.00
       2.963     0.985938       246469        71.11
       3.101     0.987500       246854        80.00
       3.259     0.989062       247244        91.43
       3.427     0.990625       247634       106.67
       3.643     0.992188       248028       128.00
       3.763     0.992969       248221       142.22
       3.911     0.993750       248418       160.00
       4.067     0.994531       248610       182.86
       4.227     0.995313       248807       213.33
       4.451     0.996094       249003       256.00
       4.567     0.996484       249100       284.44
       4.691     0.996875       249196       320.00
       4.823     0.997266       249296       365.71
       4.991     0.997656       249393       426.67
       5.219     0.998047       249489       512.00
       5.347     0.998242       249540       568.89
       5.463     0.998437       249590       640.00
       5.555     0.998633       249636       731.43
       5.719     0.998828       249685       853.33
       5.987     0.999023       249733      1024.00
       6.099     0.999121       249758      1137.78
       6.271     0.999219       249783      1280.00
       6.411     0.999316       249807      1462.86
       6.555     0.999414       249831      1706.67
       6.695     0.999512       249855      2048.00
       6.771     0.999561       249868      2275.56
       6.867     0.999609       249880      2560.00
       6.951     0.999658       249893      2925.71
       6.999     0.999707       249904      3413.33
       7.079     0.999756       249916      4096.00
       7.123     0.999780       249923      4551.11
       7.175     0.999805       249929      5120.00
       7.267     0.999829       249935      5851.43
       7.419     0.999854       249942      6826.67
       7.539     0.999878       249947      8192.00
       7.847     0.999890       249950      9102.22
       8.343     0.999902       249953     10240.00
       8.823     0.999915       249956     11702.86
       9.295     0.999927       249959     13653.33
       9.511     0.999939       249962     16384.00
       9.671     0.999945       249964     18204.44
       9.703     0.999951       249965     20480.00
       9.871     0.999957       249967     23405.71
       9.975     0.999963       249968     27306.67
      10.103     0.999969       249970     32768.00
      10.159     0.999973       249971     36408.89
      10.159     0.999976       249971     40960.00
      10.311     0.999979       249972     46811.43
      10.471     0.999982       249973     54613.33
      10.487     0.999985       249974     65536.00
      10.487     0.999986       249974     72817.78
      10.487     0.999988       249974     81920.00
      10.527     0.999989       249975     93622.86
      10.527     0.999991       249975    109226.67
      10.679     0.999992       249976    131072.00
      10.679     0.999993       249976    145635.56
      10.679     0.999994       249976    163840.00
      10.679     0.999995       249976    187245.71
      10.679     0.999995       249976    218453.33
      10.823     0.999996       249977    262144.00
      10.823     1.000000       249977          inf

#[Mean    =        0.864, StdDeviation   =        0.614]

#[Max     =       10.816, Total count    =       249977]

#[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------

С увеличением rate с 5000 до 6000 среднее значение latency возрастает в 1.27 раз.

`wrk -t 1 -c 1 -d 60 -R 6000 -s get.lua -L http://localhost:19234`  
Running 1m test @ http://localhost:19234  
1 threads and 1 connections  
Thread calibration: mean lat.: 1.059ms, rate sampling interval: 10ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     1.10ms    1.10ms  10.50ms   91.43%  
Req/Sec     6.34k   533.76    11.22k    66.57%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    0.86ms  
75.000%    1.17ms  
90.000%    2.00ms  
99.000%    6.17ms  
99.900%    9.27ms  
99.990%   10.22ms  
99.999%   10.49ms  
100.000%   10.50ms  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.032     0.000000            1         1.00
       0.289     0.100000        30169         1.11
       0.443     0.200000        59996         1.25
       0.588     0.300000        90077         1.43
       0.726     0.400000       120022         1.67
       0.860     0.500000       150174         2.00
       0.924     0.550000       165013         2.22
       0.989     0.600000       180170         2.50
       1.050     0.650000       195172         2.86
       1.109     0.700000       210027         3.33
       1.170     0.750000       225159         4.00
       1.203     0.775000       232526         4.44
       1.267     0.800000       239992         5.00
       1.417     0.825000       247502         5.71
       1.587     0.850000       255003         6.67
       1.779     0.875000       262476         8.00
       1.886     0.887500       266256         8.89
       1.999     0.900000       269995        10.00
       2.169     0.912500       273755        11.43
       2.445     0.925000       277474        13.33
       2.789     0.937500       281237        16.00
       2.981     0.943750       283101        17.78
       3.195     0.950000       284976        20.00
       3.443     0.956250       286859        22.86
       3.743     0.962500       288724        26.67
       4.107     0.968750       290603        32.00
       4.307     0.971875       291536        35.56
       4.499     0.975000       292483        40.00
       4.731     0.978125       293411        45.71
       5.027     0.981250       294347        53.33
       5.407     0.984375       295289        64.00
       5.591     0.985938       295757        71.11
       5.771     0.987500       296221        80.00
       6.035     0.989062       296692        91.43
       6.255     0.990625       297161       106.67
       6.543     0.992188       297626       128.00
       6.775     0.992969       297863       142.22
       6.947     0.993750       298096       160.00
       7.135     0.994531       298334       182.86
       7.407     0.995313       298564       213.33
       7.743     0.996094       298799       256.00
       7.995     0.996484       298915       284.44
       8.263     0.996875       299032       320.00
       8.479     0.997266       299150       365.71
       8.591     0.997656       299269       426.67
       8.831     0.998047       299389       512.00
       8.935     0.998242       299445       568.89
       9.039     0.998437       299501       640.00
       9.087     0.998633       299559       731.43
       9.199     0.998828       299618       853.33
       9.295     0.999023       299682      1024.00
       9.383     0.999121       299708      1137.78
       9.503     0.999219       299736      1280.00
       9.663     0.999316       299764      1462.86
       9.815     0.999414       299794      1706.67
       9.943     0.999512       299824      2048.00
       9.991     0.999561       299839      2275.56
      10.031     0.999609       299854      2560.00
      10.071     0.999658       299869      2925.71
      10.095     0.999707       299884      3413.33
      10.119     0.999756       299900      4096.00
      10.127     0.999780       299908      4551.11
      10.135     0.999805       299915      5120.00
      10.143     0.999829       299921      5851.43
      10.159     0.999854       299927      6826.67
      10.183     0.999878       299933      8192.00
      10.207     0.999890       299938      9102.22
      10.231     0.999902       299940     10240.00
      10.271     0.999915       299944     11702.86
      10.327     0.999927       299948     13653.33
      10.351     0.999939       299951     16384.00
      10.375     0.999945       299953     18204.44
      10.399     0.999951       299955     20480.00
      10.423     0.999957       299957     23405.71
      10.447     0.999963       299960     27306.67
      10.447     0.999969       299960     32768.00
      10.455     0.999973       299961     36408.89
      10.471     0.999976       299963     40960.00
      10.471     0.999979       299963     46811.43
      10.479     0.999982       299964     54613.33
      10.487     0.999985       299966     65536.00
      10.487     0.999986       299966     72817.78
      10.487     0.999988       299966     81920.00
      10.487     0.999989       299966     93622.86
      10.495     0.999991       299967    109226.67
      10.495     0.999992       299967    131072.00
      10.495     0.999993       299967    145635.56
      10.503     0.999994       299969    163840.00
      10.503     1.000000       299969          inf

#[Mean    =        1.102, StdDeviation   =        1.103]

#[Max     =       10.496, Total count    =       299969]

#[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------

#### **Профилирование (CPU и alloc) с помощью async-profiler**
##### PUT-запросы
**CPU**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/put_cpu.jpg)

- большая часть процессорного времени идёт на работу ядра (работа с сетевым протоколом, syscalls), запросами (one.nio);
- ~3% затрачивается на работу с MemorySegment;
- ~1% времени идёт на работу БД.

**alloc**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/put_alloc.jpg)

Исходя из полученных результатов, можно подытожить, что 
- ~9% памяти затрачивается на работу с MemorySegment;
- ~7% памяти затрачивается на обработку запроса put реализованным DemoService;
- ~27% памяти затрачивается на работу java.lang, java.util (массивы, concurrency - put в SkipListMap);
- остальная память идёт на работу one.nio (работу с массивом байт, сессиями, а также создание и обработку запросов). 

##### GET-запросы
**CPU**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/get_cpu.jpg)

- ~22% затрачивается на работу с MemorySegment, ScopedMemoryAccess;
- ~30% времени идёт на работу БД (работа с итераторами MergeIterator, IndexedPeekIterator; методы upsert, compare), а на MemoryAccess;
- остальная часть процессорного времени идёт на работу ядра (работа с сетевым протоколом, syscalls), запросами (one.nio);

**alloc**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/get_alloc.jpg)

Исходя из полученных результатов, можно подытожить, что 
- ~84% памяти затрачивается на работу с MappedMemorySegment;
- ~12% памяти затрачивается на работу БД (10% - метод iterate, 2% - метод entryAt);
- остальная память идёт на работу one.nio (работу с массивом байт, сессиями, а также создание и обработку запросов). 
