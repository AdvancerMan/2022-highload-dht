### **STAGE 1**

Для выполнения работы была использована своя реализацию DAO из весеннего курса 2022-nosql-lsm.

#### **Нагрузочное тестирование**
##### PUT-запросы
Для определения стабильной нагрузки параметр -R (rate) варьировался следующим образом: { 1000, 10000, 20000, 30000, 40000, 50000 }.
Среднее значение latency при искомом параметре, равном 50000, достигало 1.94 с, при 46000 - 2.89 мс, а при 40000 - менее одной миллисекунды. Таким образом было выбрано значение rate = 45000, при котором интересующий нас параметр latency avg стал принимать значение 0.96 мс.

`wrk -t 1 -c 1 -d 1m -R 45000 -s put.lua -L http://localhost:19234`
Running 1m test @ http://localhost:19234
  1 threads and 1 connections
  Thread calibration: mean lat.: 65.427ms, rate sampling interval: 289ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.96ms    1.13ms  10.56ms   91.13%
    Req/Sec    37.41k    16.87k   46.15k    83.24%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  711.00us
 75.000%    1.02ms
 90.000%    1.88ms
 99.000%    6.23ms
 99.900%    9.87ms
 99.990%   10.38ms
 99.999%   10.53ms
100.000%   10.57ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.018     0.000000            2         1.00
       0.178     0.100000       186967         1.11
       0.321     0.200000       373849         1.25
       0.454     0.300000       561273         1.43
       0.584     0.400000       747714         1.67
       0.711     0.500000       933660         2.00
       0.775     0.550000      1027661         2.22
       0.838     0.600000      1121273         2.50
       0.899     0.650000      1213409         2.86
       0.960     0.700000      1306959         3.33
       1.020     0.750000      1400331         4.00
       1.050     0.775000      1447244         4.44
       1.082     0.800000      1493445         5.00
       1.178     0.825000      1540257         5.71
       1.297     0.850000      1586646         6.67
       1.493     0.875000      1633467         8.00
       1.636     0.887500      1656667         8.89
       1.876     0.900000      1680034        10.00
       2.115     0.912500      1703413        11.43
       2.417     0.925000      1726649        13.33
       2.691     0.937500      1750109        16.00
       2.817     0.943750      1761824        17.78
       3.001     0.950000      1773343        20.00
       3.197     0.956250      1785044        22.86
       3.419     0.962500      1796657        26.67
       3.703     0.968750      1808300        32.00
       3.871     0.971875      1814177        35.56
       4.055     0.975000      1819993        40.00
       4.307     0.978125      1825877        45.71
       4.615     0.981250      1831662        53.33
       5.187     0.984375      1837511        64.00
       5.419     0.985938      1840395        71.11
       5.675     0.987500      1843322        80.00
       5.951     0.989062      1846234        91.43
       6.491     0.990625      1849133       106.67
       7.291     0.992188      1852060       128.00
       7.623     0.992969      1853522       142.22
       7.887     0.993750      1855024       160.00
       8.159     0.994531      1856431       182.86
       8.439     0.995313      1857929       213.33
       8.727     0.996094      1859375       256.00
       8.879     0.996484      1860098       284.44
       9.087     0.996875      1860807       320.00
       9.255     0.997266      1861554       365.71
       9.431     0.997656      1862292       426.67
       9.623     0.998047      1863043       512.00
       9.671     0.998242      1863397       568.89
       9.719     0.998437      1863715       640.00
       9.783     0.998633      1864138       731.43
       9.831     0.998828      1864475       853.33
       9.871     0.999023      1864831      1024.00
       9.887     0.999121      1865033      1137.78
       9.903     0.999219      1865185      1280.00
       9.927     0.999316      1865412      1462.86
       9.943     0.999414      1865595      1706.67
       9.975     0.999512      1865746      2048.00
       9.991     0.999561      1865854      2275.56
      10.007     0.999609      1865935      2560.00
      10.031     0.999658      1866005      2925.71
      10.071     0.999707      1866094      3413.33
      10.127     0.999756      1866183      4096.00
      10.167     0.999780      1866226      4551.11
      10.199     0.999805      1866278      5120.00
      10.239     0.999829      1866316      5851.43
      10.311     0.999854      1866359      6826.67
      10.351     0.999878      1866426      8192.00
      10.351     0.999890      1866426      9102.22
      10.383     0.999902      1866451     10240.00
      10.415     0.999915      1866473     11702.86
      10.455     0.999927      1866498     13653.33
      10.471     0.999939      1866524     16384.00
      10.479     0.999945      1866537     18204.44
      10.487     0.999951      1866567     20480.00
      10.487     0.999957      1866567     23405.71
      10.487     0.999963      1866567     27306.67
      10.495     0.999969      1866585     32768.00
      10.495     0.999973      1866585     36408.89
      10.503     0.999976      1866591     40960.00
      10.511     0.999979      1866597     46811.43
      10.511     0.999982      1866597     54613.33
      10.519     0.999985      1866603     65536.00
      10.527     0.999986      1866608     72817.78
      10.535     0.999988      1866613     81920.00
      10.535     0.999989      1866613     93622.86
      10.543     0.999991      1866619    109226.67
      10.543     0.999992      1866619    131072.00
      10.543     0.999993      1866619    145635.56
      10.551     0.999994      1866624    163840.00
      10.551     0.999995      1866624    187245.71
      10.551     0.999995      1866624    218453.33
      10.551     0.999996      1866624    262144.00
      10.559     0.999997      1866629    291271.11
      10.559     0.999997      1866629    327680.00
      10.559     0.999997      1866629    374491.43
      10.559     0.999998      1866629    436906.67
      10.559     0.999998      1866629    524288.00
      10.559     0.999998      1866629    582542.22
      10.559     0.999998      1866629    655360.00
      10.559     0.999999      1866629    748982.86
      10.559     0.999999      1866629    873813.33
      10.567     0.999999      1866631   1048576.00
      10.567     1.000000      1866631          inf
[Mean    =        0.959, StdDeviation   =        1.131]

[Max     =       10.560, Total count    =      1866631]

[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------

`wrk -t 1 -c 1 -d 1m -R 46000 -s put.lua -L http://localhost:19234`
Running 1m test @ http://localhost:19234
  1 threads and 1 connections
  Thread calibration: mean lat.: 114.967ms, rate sampling interval: 341ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.89ms    5.40ms  35.62ms   90.94%
    Req/Sec    24.56k    22.95k   47.71k    52.74%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.90ms
 75.000%    2.43ms
 90.000%    7.16ms
 99.000%   28.01ms
 99.900%   34.91ms
 99.990%   35.58ms
 99.999%   35.65ms
100.000%   35.65ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.018     0.000000            7         1.00
       0.230     0.100000       122552         1.11
       0.410     0.200000       244944         1.25
       0.573     0.300000       366508         1.43
       0.736     0.400000       488598         1.67
       0.896     0.500000       611162         2.00
       0.975     0.550000       671910         2.22
       1.050     0.600000       732776         2.50
       1.205     0.650000       793878         2.86
       1.623     0.700000       854926         3.33
       2.431     0.750000       916025         4.00
       2.803     0.775000       946491         4.44
       3.247     0.800000       977055         5.00
       3.745     0.825000      1007594         5.71
       4.543     0.850000      1038095         6.67
       5.739     0.875000      1068571         8.00
       6.291     0.887500      1083859         8.89
       7.163     0.900000      1099114        10.00
       9.431     0.912500      1114367        11.43
      11.663     0.925000      1129670        13.33
      13.263     0.937500      1145029        16.00
      14.031     0.943750      1152535        17.78
      15.191     0.950000      1160190        20.00
      16.671     0.956250      1167840        22.86
      18.255     0.962500      1175593        26.67
      20.175     0.968750      1183147        32.00
      21.055     0.971875      1186912        35.56
      22.191     0.975000      1190873        40.00
      22.511     0.978125      1194533        45.71
      23.327     0.981250      1198377        53.33
      24.399     0.984375      1202152        64.00
      25.935     0.985938      1204055        71.11
      26.959     0.987500      1205996        80.00
      27.679     0.989062      1207909        91.43
      28.463     0.990625      1209780       106.67
      29.791     0.992188      1211700       128.00
      30.159     0.992969      1212646       142.22
      30.719     0.993750      1213622       160.00
      30.991     0.994531      1214612       182.86
      31.183     0.995313      1215559       213.33
      31.455     0.996094      1216481       256.00
      31.695     0.996484      1216937       284.44
      32.207     0.996875      1217431       320.00
      32.799     0.997266      1217896       365.71
      33.375     0.997656      1218410       426.67
      33.855     0.998047      1218885       512.00
      34.047     0.998242      1219084       568.89
      34.271     0.998437      1219323       640.00
      34.527     0.998633      1219563       731.43
      34.719     0.998828      1219814       853.33
      34.943     0.999023      1220057      1024.00
      35.071     0.999121      1220220      1137.78
      35.135     0.999219      1220282      1280.00
      35.199     0.999316      1220388      1462.86
      35.327     0.999414      1220560      1706.67
      35.423     0.999512      1220692      2048.00
      35.423     0.999561      1220692      2275.56
      35.455     0.999609      1220765      2560.00
      35.487     0.999658      1220819      2925.71
      35.519     0.999707      1220912      3413.33
      35.551     0.999756      1221069      4096.00
      35.551     0.999780      1221069      4551.11
      35.551     0.999805      1221069      5120.00
      35.551     0.999829      1221069      5851.43
      35.551     0.999854      1221069      6826.67
      35.583     0.999878      1221142      8192.00
      35.583     0.999890      1221142      9102.22
      35.583     0.999902      1221142     10240.00
      35.583     0.999915      1221142     11702.86
      35.583     0.999927      1221142     13653.33
      35.615     0.999939      1221191     16384.00
      35.615     0.999945      1221191     18204.44
      35.615     0.999951      1221191     20480.00
      35.615     0.999957      1221191     23405.71
      35.615     0.999963      1221191     27306.67
      35.615     0.999969      1221191     32768.00
      35.615     0.999973      1221191     36408.89
      35.647     0.999976      1221222     40960.00
      35.647     1.000000      1221222          inf
[Mean    =        2.887, StdDeviation   =        5.405]

[Max     =       35.616, Total count    =      1221222]

[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------

##### GET-запросы на заполненной (~1000000 записей) БД
Для определения стабильной нагрузки параметр -R (rate) варьировался следующим образом: { 1000, 10000 }.
Среднее значение latency при искомом параметре, равном 10000, достигало 2.76 с, при 9000 - 1.03 с, а **при 8000 - 1.62 мс**.

`wrk -t 1 -c 1 -d 30 -R 8000 -s get.lua -L http://localhost:19234`
Running 30s test @ http://localhost:19234
  1 threads and 1 connections
  Thread calibration: mean lat.: 47.132ms, rate sampling interval: 365ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.62ms    3.17ms  26.14ms   92.95%
    Req/Sec     8.01k    83.73     8.39k    88.89%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  831.00us
 75.000%    1.14ms
 90.000%    2.97ms
 99.000%   20.66ms
 99.900%   25.69ms
 99.990%   26.09ms
 99.999%   26.16ms
100.000%   26.16ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.098     0.000000            1         1.00
       0.277     0.100000        16057         1.11
       0.424     0.200000        32038         1.25
       0.564     0.300000        48031         1.43
       0.700     0.400000        63995         1.67
       0.831     0.500000        79997         2.00
       0.895     0.550000        88036         2.22
       0.957     0.600000        96080         2.50
       1.017     0.650000       104013         2.86
       1.079     0.700000       112005         3.33
       1.140     0.750000       120053         4.00
       1.172     0.775000       123980         4.44
       1.268     0.800000       127985         5.00
       1.417     0.825000       131984         5.71
       1.634     0.850000       135976         6.67
       2.053     0.875000       139972         8.00
       2.447     0.887500       141974         8.89
       2.971     0.900000       143976        10.00
       3.713     0.912500       145972        11.43
       4.479     0.925000       147976        13.33
       5.207     0.937500       149974        16.00
       5.719     0.943750       150973        17.78
       6.175     0.950000       151979        20.00
       6.651     0.956250       152969        22.86
       7.955     0.962500       153968        26.67
       9.327     0.968750       154979        32.00
      10.279     0.971875       155466        35.56
      11.351     0.975000       155970        40.00
      12.191     0.978125       156469        45.71
      13.247     0.981250       156968        53.33
      16.127     0.984375       157466        64.00
      17.695     0.985938       157719        71.11
      18.463     0.987500       157967        80.00
      19.823     0.989062       158218        91.43
      20.895     0.990625       158468       106.67
      21.663     0.992188       158719       128.00
      21.903     0.992969       158844       142.22
      22.479     0.993750       158967       160.00
      23.327     0.994531       159092       182.86
      23.919     0.995313       159218       213.33
      24.463     0.996094       159341       256.00
      24.879     0.996484       159403       284.44
      25.231     0.996875       159471       320.00
      25.311     0.997266       159530       365.71
      25.439     0.997656       159591       426.67
      25.551     0.998047       159670       512.00
      25.583     0.998242       159695       568.89
      25.615     0.998437       159717       640.00
      25.647     0.998633       159759       731.43
      25.663     0.998828       159780       853.33
      25.695     0.999023       159815      1024.00
      25.711     0.999121       159831      1137.78
      25.727     0.999219       159850      1280.00
      25.743     0.999316       159859      1462.86
      25.775     0.999414       159881      1706.67
      25.791     0.999512       159887      2048.00
      25.823     0.999561       159896      2275.56
      25.855     0.999609       159906      2560.00
      25.903     0.999658       159913      2925.71
      25.935     0.999707       159924      3413.33
      25.951     0.999756       159926      4096.00
      25.983     0.999780       159931      4551.11
      26.015     0.999805       159935      5120.00
      26.047     0.999829       159939      5851.43
      26.079     0.999854       159944      6826.67
      26.095     0.999878       159949      8192.00
      26.095     0.999890       159949      9102.22
      26.111     0.999902       159954     10240.00
      26.111     0.999915       159954     11702.86
      26.111     0.999927       159954     13653.33
      26.127     0.999939       159956     16384.00
      26.143     0.999945       159962     18204.44
      26.143     0.999951       159962     20480.00
      26.143     0.999957       159962     23405.71
      26.143     0.999963       159962     27306.67
      26.143     0.999969       159962     32768.00
      26.143     0.999973       159962     36408.89
      26.143     0.999976       159962     40960.00
      26.143     0.999979       159962     46811.43
      26.159     0.999982       159965     54613.33
      26.159     1.000000       159965          inf
[Mean    =        1.619, StdDeviation   =        3.169]

[Max     =       26.144, Total count    =       159965]

[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------
С увеличением rate с 8000 до 9000 среднее значение latency значительно возрастает: в 10^3 раз.

`wrk -t 1 -c 1 -d 30 -R 9000 -s get.lua -L http://localhost:19234`
Running 30s test @ http://localhost:19234
  1 threads and 1 connections
  Thread calibration: mean lat.: 214.454ms, rate sampling interval: 610ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.03s   502.40ms   1.80s    59.07%
    Req/Sec     8.32k   477.77     9.52k    81.25%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.13s
 75.000%    1.46s
 90.000%    1.66s
 99.000%    1.79s
 99.900%    1.80s
 99.990%    1.81s
 99.999%    1.81s
100.000%    1.81s

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

     210.687     0.000000            3         1.00
     261.631     0.100000        16645         1.11
     357.887     0.200000        33280         1.25
     734.207     0.300000        49868         1.43
     905.727     0.400000        66493         1.67
    1128.447     0.500000        83183         2.00
    1179.647     0.550000        91593         2.22
    1260.543     0.600000        99747         2.50
    1334.271     0.650000       108213         2.86
    1400.831     0.700000       116411         3.33
    1457.151     0.750000       124724         4.00
    1490.943     0.775000       128862         4.44
    1512.447     0.800000       133031         5.00
    1551.359     0.825000       137207         5.71
    1585.151     0.850000       141412         6.67
    1620.991     0.875000       145556         8.00
    1636.351     0.887500       147534         8.89
    1655.807     0.900000       149674        10.00
    1671.167     0.912500       151905        11.43
    1689.599     0.925000       153808        13.33
    1709.055     0.937500       155873        16.00
    1718.271     0.943750       156960        17.78
    1729.535     0.950000       157971        20.00
    1745.919     0.956250       159030        22.86
    1754.111     0.962500       160004        26.67
    1766.399     0.968750       161083        32.00
    1772.543     0.971875       161669        35.56
    1775.615     0.975000       162078        40.00
    1779.711     0.978125       162785        45.71
    1782.783     0.981250       163117        53.33
    1786.879     0.984375       163835        64.00
    1787.903     0.985938       163936        71.11
    1789.951     0.987500       164169        80.00
    1791.999     0.989062       164436        91.43
    1794.047     0.990625       164836       106.67
    1796.095     0.992188       165033       128.00
    1797.119     0.992969       165191       142.22
    1797.119     0.993750       165191       160.00
    1798.143     0.994531       165421       182.86
    1799.167     0.995313       165572       213.33
    1800.191     0.996094       165708       256.00
    1800.191     0.996484       165708       284.44
    1800.191     0.996875       165708       320.00
    1801.215     0.997266       165801       365.71
    1802.239     0.997656       165936       426.67
    1802.239     0.998047       165936       512.00
    1802.239     0.998242       165936       568.89
    1803.263     0.998437       166080       640.00
    1803.263     0.998633       166080       731.43
    1803.263     0.998828       166080       853.33
    1803.263     0.999023       166080      1024.00
    1803.263     0.999121       166080      1137.78
    1804.287     0.999219       166181      1280.00
    1804.287     0.999316       166181      1462.86
    1804.287     0.999414       166181      1706.67
    1804.287     0.999512       166181      2048.00
    1804.287     0.999561       166181      2275.56
    1804.287     0.999609       166181      2560.00
    1804.287     0.999658       166181      2925.71
    1804.287     0.999707       166181      3413.33
    1805.311     0.999756       166225      4096.00
    1805.311     1.000000       166225          inf
[Mean    =     1027.452, StdDeviation   =      502.404]

[Max     =     1804.288, Total count    =       166225]

[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------

#### **Профилирование (CPU и alloc) с помощью async-profiler**
##### PUT-запросы
**CPU**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/put_cpu.jpg)

**alloc**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/put_alloc.jpg)

Исходя из полученных результатов, можно подытожить, что 
    - ~9% памяти затрачивается на работу с MemorySegment;
    - ~7% памяти затрачивается на обработку запроса put реализованным DemoService;
    - ~27% памяти затрачивается на работу java.lang, java.util (массивы, concurrency - put в SkipListMap);
    - остальная память идёт на работу one.nio (работу с массивом байт, сессиями, а также создание и обработку запросов). 

##### GET-запросы
**CPU**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/get_cpu.jpg)

**alloc**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/get_alloc.jpg)

Исходя из полученных результатов, можно подытожить, что 
    - ~84% памяти затрачивается на работу с MappedMemorySegment;
    - ~12% памяти затрачивается на работу БД (10% - метод iterate, 2% - метод entryAt);
    - остальная память идёт на работу one.nio (работу с массивом байт, сессиями, а также создание и обработку запросов). 
