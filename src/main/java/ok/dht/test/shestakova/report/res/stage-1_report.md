### **STAGE 1**

Для выполнения работы была использована своя реализацию DAO из весеннего курса 2022-nosql-lsm.

#### **Нагрузочное тестирование**
##### PUT-запросы
Для определения стабильной нагрузки параметр -R (rate) варьировался следующим образом: { 1000, 10000, 20000, 30000, 40000, 50000 }.
Среднее значение latency при искомом параметре, равном 50000, достигало 1.94 с, при 46000 - 2.89 мс, а при 40000 - менее одной миллисекунды. Таким образом было выбрано значение **rate = 40000, при котором интересующий нас параметр latency avg стал принимать значение 0.86 мс**.
На 90% запросов затрачивалось не более 1.01 мс при rate = 40000, а при увеличении rate = 41000 на 90% запросов затрачивалось около 1.0 мс, но сервис уже не справляется с этой нагрузкой (вылетает ошибка - таймаут), из чего можно сделать вывод о том, что первый вариант можно считать рабочей нагрузкой.

`wrk -t 1 -c 1 -d 60 -R 40000 -s put.lua -L http://localhost:19234`  
Running 1m test @ http://localhost:19234  
1 threads and 1 connections  
Thread calibration: mean lat.: 56.936ms, rate sampling interval: 280ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     0.86ms    2.72ms  39.52ms   98.44%  
Req/Sec    40.07k   553.30    43.48k    97.19%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%  572.00us  
75.000%  844.00us  
90.000%    1.01ms  
99.000%   11.12ms  
99.900%   37.34ms  
99.990%   39.17ms  
99.999%   39.52ms  
100.000%   39.55ms  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.018     0.000000           98         1.00
       0.132     0.100000       200344         1.11
       0.243     0.200000       400281         1.25
       0.354     0.300000       600983         1.43
       0.463     0.400000       800247         1.67
       0.572     0.500000      1000719         2.00
       0.627     0.550000      1101307         2.22
       0.681     0.600000      1200149         2.50
       0.736     0.650000      1300877         2.86
       0.790     0.700000      1400753         3.33
       0.844     0.750000      1500771         4.00
       0.871     0.775000      1550313         4.44
       0.898     0.800000      1599974         5.00
       0.926     0.825000      1651590         5.71
       0.953     0.850000      1701337         6.67
       0.980     0.875000      1751120         8.00
       0.993     0.887500      1775255         8.89
       1.007     0.900000      1801260        10.00
       1.020     0.912500      1825414        11.43
       1.034     0.925000      1851495        13.33
       1.047     0.937500      1875797        16.00
       1.054     0.943750      1888926        17.78
       1.060     0.950000      1900104        20.00
       1.067     0.956250      1913603        22.86
       1.073     0.962500      1926258        26.67
       1.125     0.968750      1937426        32.00
       1.220     0.971875      1943627        35.56
       1.418     0.975000      1949843        40.00
       1.822     0.978125      1956091        45.71
       2.517     0.981250      1962340        53.33
       3.581     0.984375      1968588        64.00
       4.535     0.985938      1971714        71.11
       5.367     0.987500      1974842        80.00
       7.791     0.989062      1977958        91.43
      12.719     0.990625      1981085       106.67
      17.199     0.992188      1984217       128.00
      19.167     0.992969      1985774       142.22
      21.711     0.993750      1987351       160.00
      22.991     0.994531      1988899       182.86
      25.567     0.995313      1990458       213.33
      29.855     0.996094      1992020       256.00
      32.095     0.996484      1992803       284.44
      33.663     0.996875      1993590       320.00
      34.591     0.997266      1994392       365.71
      35.647     0.997656      1995192       426.67
      35.903     0.998047      1995928       512.00
      36.191     0.998242      1996328       568.89
      36.511     0.998437      1996717       640.00
      36.831     0.998633      1997102       731.43
      37.119     0.998828      1997551       853.33
      37.407     0.999023      1997889      1024.00
      37.631     0.999121      1998082      1137.78
      37.823     0.999219      1998324      1280.00
      37.855     0.999316      1998470      1462.86
      37.919     0.999414      1998749      1706.67
      37.951     0.999512      1998856      2048.00
      38.015     0.999561      1998990      2275.56
      38.047     0.999609      1999053      2560.00
      38.143     0.999658      1999180      2925.71
      38.271     0.999707      1999261      3413.33
      38.463     0.999756      1999347      4096.00
      38.591     0.999780      1999395      4551.11
      38.719     0.999805      1999442      5120.00
      38.943     0.999829      1999498      5851.43
      39.071     0.999854      1999548      6826.67
      39.135     0.999878      1999613      8192.00
      39.135     0.999890      1999613      9102.22
      39.167     0.999902      1999637     10240.00
      39.199     0.999915      1999663     11702.86
      39.263     0.999927      1999692     13653.33
      39.327     0.999939      1999727     16384.00
      39.327     0.999945      1999727     18204.44
      39.359     0.999951      1999747     20480.00
      39.359     0.999957      1999747     23405.71
      39.391     0.999963      1999758     27306.67
      39.423     0.999969      1999770     32768.00
      39.455     0.999973      1999783     36408.89
      39.455     0.999976      1999783     40960.00
      39.487     0.999979      1999792     46811.43
      39.519     0.999982      1999815     54613.33
      39.519     0.999985      1999815     65536.00
      39.519     0.999986      1999815     72817.78
      39.519     0.999988      1999815     81920.00
      39.519     0.999989      1999815     93622.86
      39.519     0.999991      1999815    109226.67
      39.551     0.999992      1999831    131072.00
      39.551     1.000000      1999831          inf

[Mean    =        0.856, StdDeviation   =        2.719]

[Max     =       39.520, Total count    =      1999831]

[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------
2399984 requests in 1.00m, 153.35MB read  
Requests/sec:  39999.84  
Transfer/sec:      2.56MB  

`wrk -t 1 -c 1 -d 60 -R 41000 -s put.lua -L http://localhost:19234`  
Running 1m test @ http://localhost:19234  
1 threads and 1 connections  
Thread calibration: mean lat.: 7.729ms, rate sampling interval: 74ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency   632.98us  746.11us  15.82ms   97.96%  
Req/Sec    38.95k     9.51k   45.97k    94.37%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%  569.00us  
75.000%  840.00us  
90.000%    1.00ms  
99.000%    3.22ms  
99.900%   11.64ms  
99.990%   15.44ms  
99.999%   15.78ms  
100.000%   15.82ms  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.018     0.000000           53         1.00
       0.131     0.100000       193477         1.11
       0.242     0.200000       388260         1.25
       0.351     0.300000       580720         1.43
       0.460     0.400000       773404         1.67
       0.569     0.500000       966625         2.00
       0.624     0.550000      1064508         2.22
       0.678     0.600000      1160745         2.50
       0.732     0.650000      1256937         2.86
       0.786     0.700000      1353610         3.33
       0.840     0.750000      1450782         4.00
       0.867     0.775000      1498938         4.44
       0.894     0.800000      1547368         5.00
       0.921     0.825000      1595325         5.71
       0.948     0.850000      1643570         6.67
       0.975     0.875000      1691458         8.00
       0.989     0.887500      1716570         8.89
       1.002     0.900000      1739907        10.00
       1.016     0.912500      1765015        11.43
       1.029     0.925000      1788442        13.33
       1.043     0.937500      1813731        16.00
       1.049     0.943750      1824535        17.78
       1.056     0.950000      1837206        20.00
       1.063     0.956250      1849857        22.86
       1.069     0.962500      1861011        26.67
       1.076     0.968750      1872995        32.00
       1.113     0.971875      1878689        35.56
       1.191     0.975000      1884762        40.00
       1.306     0.978125      1890789        45.71
       1.527     0.981250      1896814        53.33
       2.004     0.984375      1902852        64.00
       2.313     0.985938      1905868        71.11
       2.619     0.987500      1908891        80.00
       2.971     0.989062      1911918        91.43
       3.389     0.990625      1914929       106.67
       3.969     0.992188      1917951       128.00
       4.287     0.992969      1919471       142.22
       4.587     0.993750      1920977       160.00
       5.023     0.994531      1922481       182.86
       5.535     0.995313      1923992       213.33
       6.111     0.996094      1925505       256.00
       6.415     0.996484      1926257       284.44
       6.759     0.996875      1927014       320.00
       7.147     0.997266      1927767       365.71
       7.727     0.997656      1928520       426.67
       8.831     0.998047      1929274       512.00
       9.303     0.998242      1929660       568.89
       9.687     0.998437      1930032       640.00
      10.279     0.998633      1930410       731.43
      11.143     0.998828      1930786       853.33
      11.711     0.999023      1931164      1024.00
      11.959     0.999121      1931352      1137.78
      12.271     0.999219      1931540      1280.00
      12.735     0.999316      1931736      1462.86
      13.199     0.999414      1931918      1706.67
      13.647     0.999512      1932108      2048.00
      13.919     0.999561      1932202      2275.56
      14.127     0.999609      1932296      2560.00
      14.383     0.999658      1932389      2925.71
      14.583     0.999707      1932485      3413.33
      14.831     0.999756      1932578      4096.00
      14.935     0.999780      1932627      4551.11
      15.039     0.999805      1932673      5120.00
      15.143     0.999829      1932719      5851.43
      15.223     0.999854      1932770      6826.67
      15.343     0.999878      1932815      8192.00
      15.407     0.999890      1932838      9102.22
      15.447     0.999902      1932862     10240.00
      15.511     0.999915      1932885     11702.86
      15.543     0.999927      1932910     13653.33
      15.559     0.999939      1932933     16384.00
      15.575     0.999945      1932946     18204.44
      15.599     0.999951      1932956     20480.00
      15.631     0.999957      1932968     23405.71
      15.663     0.999963      1932981     27306.67
      15.695     0.999969      1932991     32768.00
      15.711     0.999973      1932998     36408.89
      15.727     0.999976      1933004     40960.00
      15.743     0.999979      1933010     46811.43
      15.759     0.999982      1933017     54613.33
      15.767     0.999985      1933022     65536.00
      15.775     0.999986      1933028     72817.78
      15.775     0.999988      1933028     81920.00
      15.783     0.999989      1933036     93622.86
      15.783     0.999991      1933036    109226.67
      15.783     0.999992      1933036    131072.00
      15.783     0.999993      1933036    145635.56
      15.791     0.999994      1933038    163840.00
      15.799     0.999995      1933040    187245.71
      15.807     0.999995      1933045    218453.33
      15.807     0.999996      1933045    262144.00
      15.807     0.999997      1933045    291271.11
      15.807     0.999997      1933045    327680.00
      15.807     0.999997      1933045    374491.43
      15.807     0.999998      1933045    436906.67
      15.815     0.999998      1933048    524288.00
      15.815     0.999998      1933048    582542.22
      15.815     0.999998      1933048    655360.00
      15.815     0.999999      1933048    748982.86
      15.815     0.999999      1933048    873813.33
      15.815     0.999999      1933048   1048576.00
      15.815     0.999999      1933048   1165084.44
      15.815     0.999999      1933048   1310720.00
      15.815     0.999999      1933048   1497965.71
      15.815     0.999999      1933048   1747626.67
      15.823     1.000000      1933049   2097152.00
      15.823     1.000000      1933049          inf

[Mean    =        0.633, StdDeviation   =        0.746]

[Max     =       15.816, Total count    =      1933049]

[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------  
2343212 requests in 1.00m, 149.72MB read  
Socket errors: connect 0, read 0, write 0, timeout 1  
Requests/sec:  39050.34  
Transfer/sec:      2.50MB  


##### GET-запросы на заполненной (~1000000 записей) БД
Для определения стабильной нагрузки параметр -R (rate) варьировался следующим образом: { 1000, 2000, 3000, 4000, 5000, 6000, 10000 }.
Среднее значение latency при искомом параметре, равном 10000, достигало 2.76 с, при 6000 - 1.10 мс, а **при 5000 - 0.86 мс**.
На 90% запросов затрачивалось не более 1.29 мс при rate = 5000, 2.0 мс при rate = 6000, из чего можно сделать вывод о том, что первый вариант можно считать рабочей нагрузкой.

`wrk -t 1 -c 1 -d 60 -R 5000 -s get.lua -L http://localhost:19234`  
Running 1m test @ http://localhost:19234  
1 threads and 1 connections  
Thread calibration: mean lat.: 0.865ms, rate sampling interval: 10ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     0.86ms  614.42us  10.82ms   83.27%  
Req/Sec     5.28k   416.60     7.70k    77.72%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%  784.00us  
75.000%    1.09ms  
90.000%    1.39ms  
99.000%    3.36ms  
99.900%    5.97ms  
99.990%    8.18ms  
99.999%   10.53ms  
100.000%   10.82ms  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.033     0.000000            1         1.00
       0.277     0.100000        25020         1.11
       0.406     0.200000        50088         1.25
       0.534     0.300000        75169         1.43
       0.660     0.400000       100077         1.67
       0.784     0.500000       125203         2.00
       0.846     0.550000       137520         2.22
       0.907     0.600000       150084         2.50
       0.967     0.650000       162491         2.86
       1.027     0.700000       175034         3.33
       1.086     0.750000       187679         4.00
       1.115     0.775000       193929         4.44
       1.144     0.800000       200156         5.00
       1.173     0.825000       206240         5.71
       1.204     0.850000       212640         6.67
       1.238     0.875000       218777         8.00
       1.292     0.887500       221867         8.89
       1.389     0.900000       225015        10.00
       1.495     0.912500       228127        11.43
       1.608     0.925000       231243        13.33
       1.730     0.937500       234359        16.00
       1.795     0.943750       235921        17.78
       1.860     0.950000       237486        20.00
       1.933     0.956250       239042        22.86
       2.012     0.962500       240603        26.67
       2.139     0.968750       242166        32.00
       2.241     0.971875       242949        35.56
       2.367     0.975000       243737        40.00
       2.505     0.978125       244518        45.71
       2.655     0.981250       245292        53.33
       2.849     0.984375       246074        64.00
       2.963     0.985938       246469        71.11
       3.101     0.987500       246854        80.00
       3.259     0.989062       247244        91.43
       3.427     0.990625       247634       106.67
       3.643     0.992188       248028       128.00
       3.763     0.992969       248221       142.22
       3.911     0.993750       248418       160.00
       4.067     0.994531       248610       182.86
       4.227     0.995313       248807       213.33
       4.451     0.996094       249003       256.00
       4.567     0.996484       249100       284.44
       4.691     0.996875       249196       320.00
       4.823     0.997266       249296       365.71
       4.991     0.997656       249393       426.67
       5.219     0.998047       249489       512.00
       5.347     0.998242       249540       568.89
       5.463     0.998437       249590       640.00
       5.555     0.998633       249636       731.43
       5.719     0.998828       249685       853.33
       5.987     0.999023       249733      1024.00
       6.099     0.999121       249758      1137.78
       6.271     0.999219       249783      1280.00
       6.411     0.999316       249807      1462.86
       6.555     0.999414       249831      1706.67
       6.695     0.999512       249855      2048.00
       6.771     0.999561       249868      2275.56
       6.867     0.999609       249880      2560.00
       6.951     0.999658       249893      2925.71
       6.999     0.999707       249904      3413.33
       7.079     0.999756       249916      4096.00
       7.123     0.999780       249923      4551.11
       7.175     0.999805       249929      5120.00
       7.267     0.999829       249935      5851.43
       7.419     0.999854       249942      6826.67
       7.539     0.999878       249947      8192.00
       7.847     0.999890       249950      9102.22
       8.343     0.999902       249953     10240.00
       8.823     0.999915       249956     11702.86
       9.295     0.999927       249959     13653.33
       9.511     0.999939       249962     16384.00
       9.671     0.999945       249964     18204.44
       9.703     0.999951       249965     20480.00
       9.871     0.999957       249967     23405.71
       9.975     0.999963       249968     27306.67
      10.103     0.999969       249970     32768.00
      10.159     0.999973       249971     36408.89
      10.159     0.999976       249971     40960.00
      10.311     0.999979       249972     46811.43
      10.471     0.999982       249973     54613.33
      10.487     0.999985       249974     65536.00
      10.487     0.999986       249974     72817.78
      10.487     0.999988       249974     81920.00
      10.527     0.999989       249975     93622.86
      10.527     0.999991       249975    109226.67
      10.679     0.999992       249976    131072.00
      10.679     0.999993       249976    145635.56
      10.679     0.999994       249976    163840.00
      10.679     0.999995       249976    187245.71
      10.679     0.999995       249976    218453.33
      10.823     0.999996       249977    262144.00
      10.823     1.000000       249977          inf

#[Mean    =        0.864, StdDeviation   =        0.614]

#[Max     =       10.816, Total count    =       249977]

#[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------

С увеличением rate с 5000 до 6000 среднее значение latency возрастает в 1.27 раз.

`wrk -t 1 -c 1 -d 60 -R 6000 -s get.lua -L http://localhost:19234`  
Running 1m test @ http://localhost:19234  
1 threads and 1 connections  
Thread calibration: mean lat.: 1.059ms, rate sampling interval: 10ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     1.10ms    1.10ms  10.50ms   91.43%  
Req/Sec     6.34k   533.76    11.22k    66.57%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    0.86ms  
75.000%    1.17ms  
90.000%    2.00ms  
99.000%    6.17ms  
99.900%    9.27ms  
99.990%   10.22ms  
99.999%   10.49ms  
100.000%   10.50ms  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.032     0.000000            1         1.00
       0.289     0.100000        30169         1.11
       0.443     0.200000        59996         1.25
       0.588     0.300000        90077         1.43
       0.726     0.400000       120022         1.67
       0.860     0.500000       150174         2.00
       0.924     0.550000       165013         2.22
       0.989     0.600000       180170         2.50
       1.050     0.650000       195172         2.86
       1.109     0.700000       210027         3.33
       1.170     0.750000       225159         4.00
       1.203     0.775000       232526         4.44
       1.267     0.800000       239992         5.00
       1.417     0.825000       247502         5.71
       1.587     0.850000       255003         6.67
       1.779     0.875000       262476         8.00
       1.886     0.887500       266256         8.89
       1.999     0.900000       269995        10.00
       2.169     0.912500       273755        11.43
       2.445     0.925000       277474        13.33
       2.789     0.937500       281237        16.00
       2.981     0.943750       283101        17.78
       3.195     0.950000       284976        20.00
       3.443     0.956250       286859        22.86
       3.743     0.962500       288724        26.67
       4.107     0.968750       290603        32.00
       4.307     0.971875       291536        35.56
       4.499     0.975000       292483        40.00
       4.731     0.978125       293411        45.71
       5.027     0.981250       294347        53.33
       5.407     0.984375       295289        64.00
       5.591     0.985938       295757        71.11
       5.771     0.987500       296221        80.00
       6.035     0.989062       296692        91.43
       6.255     0.990625       297161       106.67
       6.543     0.992188       297626       128.00
       6.775     0.992969       297863       142.22
       6.947     0.993750       298096       160.00
       7.135     0.994531       298334       182.86
       7.407     0.995313       298564       213.33
       7.743     0.996094       298799       256.00
       7.995     0.996484       298915       284.44
       8.263     0.996875       299032       320.00
       8.479     0.997266       299150       365.71
       8.591     0.997656       299269       426.67
       8.831     0.998047       299389       512.00
       8.935     0.998242       299445       568.89
       9.039     0.998437       299501       640.00
       9.087     0.998633       299559       731.43
       9.199     0.998828       299618       853.33
       9.295     0.999023       299682      1024.00
       9.383     0.999121       299708      1137.78
       9.503     0.999219       299736      1280.00
       9.663     0.999316       299764      1462.86
       9.815     0.999414       299794      1706.67
       9.943     0.999512       299824      2048.00
       9.991     0.999561       299839      2275.56
      10.031     0.999609       299854      2560.00
      10.071     0.999658       299869      2925.71
      10.095     0.999707       299884      3413.33
      10.119     0.999756       299900      4096.00
      10.127     0.999780       299908      4551.11
      10.135     0.999805       299915      5120.00
      10.143     0.999829       299921      5851.43
      10.159     0.999854       299927      6826.67
      10.183     0.999878       299933      8192.00
      10.207     0.999890       299938      9102.22
      10.231     0.999902       299940     10240.00
      10.271     0.999915       299944     11702.86
      10.327     0.999927       299948     13653.33
      10.351     0.999939       299951     16384.00
      10.375     0.999945       299953     18204.44
      10.399     0.999951       299955     20480.00
      10.423     0.999957       299957     23405.71
      10.447     0.999963       299960     27306.67
      10.447     0.999969       299960     32768.00
      10.455     0.999973       299961     36408.89
      10.471     0.999976       299963     40960.00
      10.471     0.999979       299963     46811.43
      10.479     0.999982       299964     54613.33
      10.487     0.999985       299966     65536.00
      10.487     0.999986       299966     72817.78
      10.487     0.999988       299966     81920.00
      10.487     0.999989       299966     93622.86
      10.495     0.999991       299967    109226.67
      10.495     0.999992       299967    131072.00
      10.495     0.999993       299967    145635.56
      10.503     0.999994       299969    163840.00
      10.503     1.000000       299969          inf

#[Mean    =        1.102, StdDeviation   =        1.103]

#[Max     =       10.496, Total count    =       299969]

#[Buckets =           27, SubBuckets     =         2048]

----------------------------------------------------------

#### **Профилирование (CPU и alloc) с помощью async-profiler**
##### PUT-запросы
**CPU**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/put_cpu.jpg)

- большая часть процессорного времени идёт на работу ядра (работа с сетевым протоколом, syscalls), запросами (one.nio);
- ~3% затрачивается на работу с MemorySegment;
- ~1% времени идёт на работу БД.

**alloc**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/put_alloc.jpg)

Исходя из полученных результатов, можно подытожить, что 
- ~9% памяти затрачивается на работу с MemorySegment;
- ~7% памяти затрачивается на обработку запроса put реализованным DemoService;
- ~27% памяти затрачивается на работу java.lang, java.util (массивы, concurrency - put в SkipListMap);
- остальная память идёт на работу one.nio (работу с массивом байт, сессиями, а также создание и обработку запросов). 

##### GET-запросы
**CPU**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/get_cpu.jpg)

- ~22% затрачивается на работу с MemorySegment, ScopedMemoryAccess;
- ~30% времени идёт на работу БД (работа с итераторами MergeIterator, IndexedPeekIterator; методы upsert, compare), а на MemoryAccess;
- остальная часть процессорного времени идёт на работу ядра (работа с сетевым протоколом, syscalls), запросами (one.nio);

**alloc**
![Иллюстрация к проекту](https://github.com/Anilochka/2022-highload-dht/blob/main/src/main/java/ok/dht/test/shestakova/report/jpg/get_alloc.jpg)

Исходя из полученных результатов, можно подытожить, что 
- ~84% памяти затрачивается на работу с MappedMemorySegment;
- ~12% памяти затрачивается на работу БД (10% - метод iterate, 2% - метод entryAt);
- остальная память идёт на работу one.nio (работу с массивом байт, сессиями, а также создание и обработку запросов). 
